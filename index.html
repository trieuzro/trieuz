<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Trình Chỉnh Sửa Phụ Đề A.I</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
  :root{
    --sub-text-color:#FFFFFF;
    --sub-bg-color:rgba(0,0,0,.5);
    --sub-font-size:1.5rem;
    --sub-bottom-pos:1.25rem;
    --subs-header-h:56px;
    --tools-collapsed-header-h:56px;
    --controls-h:72px;
    --vh: 1vh;
    --fs-bottom-gap: 18px;
  }
  @media (min-width:1024px){ :root{ --sub-font-size:1.875rem; } }

  body{ font-family:'Inter',sans-serif; }
  ::-webkit-scrollbar{ width:8px; } ::-webkit-scrollbar-track{ background:#1a202c; }
  ::-webkit-scrollbar-thumb{ background:#4a5568; border-radius:4px; } ::-webkit-scrollbar-thumb:hover{ background:#718096; }

  .subtitle-item{ cursor:pointer; transition:background-color .2s, box-shadow .2s; scroll-margin-top:16px; }
  .subtitle-item:hover{ background:#3b485f; }
  .subtitle-item.active{ background-color:rgba(34,211,238,.35); }
  .subtitle-index-badge{ min-width:1.8rem; height:1.8rem; border-radius:9999px; display:inline-flex; align-items:center; justify-content:center; font-weight:700; background:#22d3ee; color:#0b1020; margin-right:.5rem; }

  .drag-handle{ display:none; cursor:grab; -webkit-user-select:none; user-select:none; }
  .reorder-active .drag-handle{ display:inline-flex; align-items:center; justify-content:center; width:26px; height:26px; border-radius:6px; background:rgba(34,211,238,.12); margin-right:.25rem; }
  .reorder-active .drag-handle:hover{ background:rgba(34,211,238,.25); }

  @keyframes flashPulse {
    0%{ box-shadow:0 0 0 3px rgba(255,99,132,.9) inset; }
    25%{ box-shadow:0 0 0 3px rgba(255,206,86,.9) inset; }
    50%{ box-shadow:0 0 0 3px rgba(75,192,192,.9) inset; }
    75%{ box-shadow:0 0 0 3px rgba(153,102,255,.9) inset; }
    100%{ box-shadow:0 0 0 3px rgba(54,162,235,.9) inset; }
  }
  .flash-highlight{ animation:flashPulse 1.1s linear infinite; }
  .search-hit{ outline:2px dashed rgba(59,130,246,.6); outline-offset:2px; }
  .current-hit{ background:rgba(147,197,253,.22); box-shadow:0 0 0 2px rgba(147,197,253,.85) inset; }

  .editable-time{ background:#2d3748; border:1px solid #4a5568; color:#cbd5e0; font-family:monospace; text-align:center; border-radius:4px; padding:2px 4px; width:120px; outline:none; }
  .editable-time:focus{ box-shadow:0 0 0 2px rgba(99,179,237,.5); }
  .editable-text{ outline:none; }
  .editable-text:focus{ background:#2d3748; box-shadow:0 0 0 2px rgba(99,179,237,.5); border-radius:4px; }

  .drop-target{ position:relative; }
  .drop-target::before{
    content:""; position:absolute; left:0; right:0; top:-4px; height:4px;
    background: repeating-linear-gradient(90deg, rgba(34,211,238,.9), rgba(34,211,238,.9) 10px, transparent 10px, transparent 18px);
    border-radius:2px;
  }

  .spinner{ border:4px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:#63b3ed; width:24px; height:24px; animation:spin 1s ease-in-out infinite; }
  @keyframes spin{ to{ transform:rotate(360deg); } }

  .icon-btn-svg{ width:20px; height:20px; fill:white; transition:transform .3s; }
  .icon-inline{ width:1.1em; height:1.1em; flex-shrink:0; display:inline-block; }
  #subtitle-overlay{ color:var(--sub-text-color); background-color:var(--sub-bg-color); font-size:var(--sub-font-size); bottom:var(--sub-bottom-pos); text-shadow:2px 2px 4px #000; }

  /* CPS/CPL badge (no QC highlight) */
  .qc-badge{ font-size:11px; color:#D1D5DB; }

  /* Loading overlay */
  #initial-loading{ position:fixed; inset:0; background:rgba(17,24,39,.65); display:flex; align-items:center; justify-content:center; z-index:1200; -webkit-backdrop-filter:blur(2px); backdrop-filter:blur(2px); opacity:1; transition:opacity .3s ease; }
  #initial-loading.hidden{ opacity:0; pointer-events:none; }

  /* Context menu */
  #context-menu{ position:fixed; z-index:1150; background:#1f2937; border:1px solid #374151; border-radius:8px; overflow:hidden; display:none; min-width:180px; }
  #context-menu button{ display:flex; align-items:center; gap:.5rem; width:100%; text-align:left; padding:.5rem .75rem; color:#E5E7EB; font-size:14px; }
  #context-menu button:hover{ background:#374151; }

  /* Batch mode visuals */
  #subtitle-list.batch-active{ background:rgba(56,189,248,.06); }
  .selected-row{ background:rgba(34,211,238,.22) !important; box-shadow:0 0 0 2px rgba(34,211,238,.6) inset; }
  @keyframes btnBlink { 0%,100%{ box-shadow:0 0 0 0 rgba(34,211,238,.0); } 50%{ box-shadow:0 0 0 3px rgba(34,211,238,.55); } }
  .batch-active-btn{ border:2px solid #22d3ee; animation:btnBlink 1.2s infinite; }
  #batch-selectall-wrap{ width:100%; margin-top:.5rem; }

  .progress-track{ position:relative; overflow:hidden; height:10px; background:#4b5563; border-radius:9999px; }
  .progress-indet{ position:absolute; height:100%; left:-35%; width:35%; background:#22d3ee; border-radius:9999px; animation:indeterminate 1.2s ease-in-out infinite; }
  @keyframes indeterminate{ 0%{ left:-35%; width:35%; } 50%{ left:45%; width:55%; } 100%{ left:110%; width:35%; } }

  .tab-button{ transition:background-color .2s, color .2s; }
  .tab-button.active{ background:#0891b2; color:#fff; }

  .notification{ position:fixed; top:20px; right:20px; padding:1rem 1.5rem; border-radius:.5rem; color:#fff; font-weight:600; z-index:1050; opacity:0; transform:translateX(100%); transition:opacity .5s, transform .5s; }
  .notification.show{ opacity:1; transform:translateX(0); }
  .notification.success{ background:#10B981; }
  .notification.error{ background:#EF4444; }
  .notification.warning{ background:#F59E0B; }

  .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.7); display:flex; align-items:center; justify-content:center; z-index:1100; }
  .modal-content{ background:#2d3748; padding:1.5rem; border-radius:.5rem; max-width:740px; width:92%; }
  .original-text{ color:#a0aec0; font-size:.8em; border-bottom:1px dotted #4a5568; margin-bottom:4px; padding-bottom:4px; -webkit-user-select:none; user-select:none; }

  @media (min-width:1024px){
    html, body{ height:100%; }
    body{ overflow:hidden; }
    main{ height:calc(100vh - 56px); min-height:0; overflow:hidden; }
    #subtitle-list{ overflow-y:auto; min-height:0; }
    #tools-content-wrapper{ overflow-y:auto; min-height:0; }
  }
  @media (min-width:1024px){
    #subtitle-panel{ flex-basis:80%; }
    #tools-panel{ flex-basis:20%; }
  }
  #tools-content-wrapper{ overscroll-behavior:contain; touch-action:pan-y; }
  @supports (-webkit-overflow-scrolling: touch){
    #tools-content-wrapper{ -webkit-overflow-scrolling:touch; }
  }

  @media (min-width:1024px){
    #right-panel{ position:relative; }
    #tools-panel{
      position:absolute; left:0; right:0; bottom:0; top:var(--subs-header-h);
      z-index:30; box-shadow:0 -10px 30px rgba(0,0,0,.35);
      border-top-left-radius:.75rem; border-top-right-radius:.75rem;
      transform:translateY(calc(100% - var(--tools-collapsed-header-h)));
      transition:transform .28s ease-in-out;
      overflow:hidden; display:flex; flex-direction:column;
      background:#1f2937;
    }
    #tools-panel.expanded{ transform:translateY(0); }
    #tools-header{ position:sticky; bottom:0; box-shadow:0 -2px 10px rgba(0,0,0,.25); }
    #tools-content-wrapper{ flex:1; }
  }

  @media (max-width:1023px){
    html, body { height:auto; overflow:auto; }
    main{ overflow:visible; height:auto; }
    #player-shell{ flex:0 0 auto; display:flex; flex-direction:column; }
    #video-wrapper{ flex:0 0 auto; width:100%; aspect-ratio:16/9; background:#000; }
    #video-player{ width:100%; height:100%; object-fit:contain; }
    .player-controls{ padding:.5rem .75rem; }
    .control-btn{ width:36px; height:36px; font-size:18px; }
    #timeline{ height:6px; }
    #time-display{ font-size:.75rem; }
    .subtitle-item{ font-size:1rem; padding:.75rem; }
    #subtitle-list, #tools-content-wrapper{ overflow:visible; }
    .editable-time{ width:100px; }
  }
  @media (min-width:1024px){
    .control-btn{ width:48px; height:48px; font-size:22px; }
    #timeline{ height:8px; }
    #time-display{ font-size:.9rem; }
  }

  .lang-grid{ display:grid; grid-template-columns:1fr 1fr; gap:.5rem; }
  @media (min-width:768px){ .lang-grid{ gap:.75rem; } }
  .lang-col{ min-width:0; }

  #subtitle-panel{ position:relative; }
  #add-sub-line-btn.add-sub-fab{
    position:absolute; top:8px; right:8px; z-index:20;
    width:44px; height:44px; border-radius:9999px;
    display:flex; align-items:center; justify-content:center;
    font-size:22px; font-weight:700; box-shadow:0 6px 14px rgba(0,0,0,.35);
  }

  /* Custom fullscreen */
  body.custom-fs{ overflow:hidden; }
  body.custom-fs header, body.custom-fs #right-panel{ display:none; }
  body.custom-fs #player-shell{
    position:fixed; inset:0; z-index:1000; background:#000;
    display:flex; flex-direction:column; max-height:calc(var(--vh) * 100);
  }
  body.custom-fs #video-wrapper{
    flex:0 0 auto; width:100%;
    height:calc(var(--vh) * 100 - var(--controls-h) - var(--fs-bottom-gap) - env(safe-area-inset-bottom,0px));
    background:#000;
  }
  body.custom-fs #video-player{ width:100%; height:100%; object-fit:contain; }
  body.custom-fs .player-controls{
    position:fixed; left:0; right:0;
    bottom:calc(env(safe-area-inset-bottom,0px) + var(--fs-bottom-gap));
    height:var(--controls-h);
    padding-bottom:8px;
    border-top:1px solid rgba(255,255,255,.1);
    background:rgba(17,24,39,.96);
    z-index:1001;
  }

  header.collapsed{ padding-top:4px; padding-bottom:4px; }
  header.collapsed .header-controls{ display:none !important; }
  header .toggle-ico{ transition:transform .2s ease; }
  header.collapsed .toggle-ico{ transform:rotate(180deg); }

  .switch-on{ background:#059669 !important; box-shadow:0 0 0 2px rgba(16,185,129,.6); }

  @keyframes rainbowGlow{
    0%{ box-shadow:0 0 0 0 rgba(255,99,132,.8); }
    20%{ box-shadow:0 0 0 3px rgba(255,206,86,.8); }
    40%{ box-shadow:0 0 0 3px rgba(75,192,192,.8); }
    60%{ box-shadow:0 0 0 3px rgba(153,102,255,.8); }
    80%{ box-shadow:0 0 0 3px rgba(54,162,235,.8); }
    100%{ box-shadow:0 0 0 0 rgba(255,99,132,.8); }
  }
  .unsaved-glow{ animation:rainbowGlow 1.2s linear infinite; }

  #subtitle-list.reorder-active{ background:rgba(56,189,248,.08); }
  .right-tools-wrap{ display:flex; align-items:center; gap:.25rem; flex-wrap:nowrap; justify-content:flex-end; max-width:100%; }
  .right-tools-wrap > *{ flex:0 0 auto; }
  .icon-btn{ display:inline-flex; align-items:center; justify-content:center; min-width:26px; height:26px; padding:0 6px; border-radius:6px; }
</style>
</head>
<body class="bg-gray-900 text-white flex flex-col">
  <div id="notification-container"></div>
  <div id="modal-container"></div>
  <div id="initial-loading">
    <div class="flex items-center gap-3 bg-gray-800/80 rounded-lg px-4 py-3 border border-gray-700">
      <div class="spinner"></div>
      <div class="text-sm">Đang tải giao diện...</div>
    </div>
  </div>

  <header id="top-header" class="bg-gray-800 shadow-md px-3 py-2 flex items-center justify-between flex-shrink-0 flex-wrap gap-2">
    <div class="flex items-center gap-2">
      <button id="header-toggle" class="bg-gray-700 hover:bg-gray-600 rounded px-2 py-1 text-sm" title="Ẩn/Hiện thanh trên"><span class="toggle-ico">▴</span></button>
      <h1 class="text-base md:text-xl font-bold text-cyan-400">Trình Chỉnh Sửa Phụ Đề A.I</h1>
    </div>
    <div class="header-controls flex items-center space-x-2 md:space-x-4">
      <label for="video-input" class="bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-2 px-3 text-sm md:px-4 rounded-lg cursor-pointer transition inline-flex items-center gap-2">
        <svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5"/><rect x="2" y="6" width="14" height="12" rx="2"/></svg>
        <span>Chọn Video</span>
      </label>
      <label for="subtitle-input" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-3 text-sm md:px-4 rounded-lg cursor-pointer transition inline-flex items-center gap-2">
        <svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
        <span>Chọn Sub</span>
      </label>
      <input id="video-input" type="file" accept="video/*" class="hidden"/>
      <input id="subtitle-input" type="file" accept=".srt,.vtt,.ass,.ssa" class="hidden"/>
      <button id="save-srt" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 text-sm md:px-4 rounded-lg transition inline-flex items-center gap-2">
        <svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7"/><path d="M7 3v4a1 1 0 0 0 1 1h7"/></svg>
        <span>Lưu SUB</span>
      </button>
    </div>
  </header>

  <main class="flex-grow flex flex-col lg:grid lg:grid-cols-3 p-2 md:p-4 gap-4 min-h-0">
    <!-- PLAYER -->
    <div id="player-shell" class="lg:col-span-2 bg-gray-800 rounded-lg shadow-lg overflow-hidden flex flex-col min-h-0">
      <div id="video-wrapper" class="w-full bg-black flex items-center justify-center relative flex-grow min-h-0">
        <video id="video-player" class="w-full h-full cursor-pointer object-contain" crossorigin="anonymous"></video>
        <div id="subtitle-overlay" class="absolute left-1/2 -translate-x-1/2 w-11/12 text-center font-bold pointer-events-none px-4"></div>
        <div id="video-placeholder-container" class="absolute inset-0 flex items-center justify-center pointer-events-none">
          <div id="video-placeholder" class="text-gray-400 text-lg md:text-2xl text-center p-4 cursor-pointer pointer-events-auto">Kéo thả hoặc bấm vào đây để chọn video</div>
        </div>
        <div id="drag-overlay" class="absolute inset-0 bg-cyan-500 bg-opacity-50 border-4 border-dashed border-white rounded-lg items-center justify-center text-2xl font-bold hidden">Thả file video vào đây</div>
      </div>

      <div class="player-controls bg-gray-800 border-t border-gray-700 flex-shrink-0">
        <label for="timeline" class="sr-only">Thanh tiến trình video</label>
        <input id="timeline" type="range" min="0" max="1000" value="0" class="w-full bg-gray-700 rounded-lg appearance-none cursor-pointer" aria-label="Thanh tiến trình video"/>
        <div class="flex items-center justify-between mt-2 text-sm">
          <div class="flex items-center space-x-2 md:space-x-4">
            <button id="play-pause-btn" class="control-btn text-white w-10 h-10 md:w-12 md:h-12 flex items-center justify-center rounded-full hover:bg-gray-700 transition" title="Phát/Tạm dừng" aria-label="Phát hoặc tạm dừng">
              <span class="sr-only">Phát hoặc tạm dừng</span>
              <svg aria-hidden="true" data-icon="play" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z"/></svg>
              <svg aria-hidden="true" data-icon="pause" class="icon-inline hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="14" y="3" width="5" height="18" rx="1"/><rect x="5" y="3" width="5" height="18" rx="1"/></svg>
            </button>
            <button id="stop-btn" class="control-btn text-white w-10 h-10 md:w-12 md:h-12 flex items-center justify-center rounded-full hover:bg-gray-700 transition" title="Dừng" aria-label="Dừng phát">
              <span class="sr-only">Dừng phát</span>
              <svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>
            </button>
            <button id="info-btn" class="control-btn text-white w-10 h-10 md:w-12 md:h-12 flex items-center justify-center rounded-full hover:bg-gray-700 transition" aria-label="Thông tin video" title="Thông tin">
              <svg class="icon-btn-svg" viewBox="0 0 24 24"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 15h-2v-6h2v6zm-2-8V7h2v2h-2z"/></svg>
            </button>
          </div>
          <div id="time-display" class="font-mono text-xs md:text-sm">00:00:00 / 00:00:00</div>
          <div class="flex items-center space-x-2 md:space-x-4">
            <div class="hidden md:flex items-center space-x-2">
              <button id="mute-btn" class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-700 hover:bg-gray-600 transition" title="Bật/Tắt tiếng" aria-label="Bật hoặc tắt tiếng" aria-pressed="false">
                <span class="sr-only">Bật hoặc tắt tiếng</span>
                <svg aria-hidden="true" data-icon="volume-on" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z"/><path d="M16 9a5 5 0 0 1 0 6"/><path d="M19.364 18.364a9 9 0 0 0 0-12.728"/></svg>
                <svg aria-hidden="true" data-icon="volume-off" class="icon-inline hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z"/><line x1="22" x2="16" y1="9" y2="15"/><line x1="16" x2="22" y1="9" y2="15"/></svg>
              </button>
              <label for="volume-slider" class="sr-only">Âm lượng</label>
              <input id="volume-slider" type="range" min="0" max="1" step="0.01" value="1" class="w-24 h-2 bg-gray-700 rounded-lg" aria-label="Âm lượng"/>
            </div>
            <button id="fullscreen-btn" class="control-btn text-white w-10 h-10 md:w-12 md:h-12 flex items-center justify-center rounded-full hover:bg-gray-700 transition" aria-label="Toàn màn hình" title="Toàn màn hình">
              <span class="sr-only">Bật hoặc tắt toàn màn hình tuỳ chỉnh</span>
              <svg class="icon-btn-svg" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zM5 10h2V7h3V5H5v5zm14 4h-2v3h-3v2h5v-5zm0-4h-2V7h-3V5h5v5z"></path></svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div id="right-panel" class="lg:col-span-1 flex flex-col min-h-0 relative overflow-hidden">
      <!-- Mobile tabs -->
      <div class="lg:hidden flex-shrink-0 flex border-b border-gray-700">
        <button id="tab-subs" class="tab-button active flex-1 py-2 px-4 text-sm font-semibold inline-flex items-center justify-center gap-2">
          <svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"/><path d="M7 11h10"/><path d="M7 15h6"/><path d="M7 7h8"/></svg>
          <span>Phụ đề</span>
        </button>
        <button id="tab-tools" class="tab-button flex-1 py-2 px-4 text-sm font-semibold bg-gray-700 text-gray-300 inline-flex items-center justify-center gap-2">
          <svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.106-3.105c.32-.322.863-.22.983.218a6 6 0 0 1-8.259 7.057l-7.91 7.91a1 1 0 0 1-2.999-3l7.91-7.91a6 6 0 0 1 7.057-8.259c.438.12.54.662.219.984z"/></svg>
          <span>Công cụ</span>
        </button>
      </div>

      <!-- Subtitle panel -->
      <div id="subtitle-panel" class="flex flex-col bg-gray-800 rounded-lg shadow-lg overflow-hidden lg:flex lg:basis-2/3 min-h-0">
        <div id="subtitle-header-wrap">
          <div id="subtitle-header" class="p-3 bg-gray-700 flex-shrink-0 flex justify-between items-center flex-wrap gap-2">
            <div class="min-w-[240px]">
              <h2 class="text-lg font-semibold">Bảng Chỉnh Sửa Phụ Đề</h2>
              <div id="subtitle-lang-display" class="text-xs text-gray-300 mt-1">Ngôn ngữ hiện tại: Chưa xác định</div>
            </div>

            <div class="flex items-center gap-2 flex-1 justify-end">
              <!-- search -->
              <div class="flex items-stretch gap-1">
                <input id="subtitle-search-input" type="text" placeholder="Tìm trong phụ đề..." class="w-40 md:w-64 bg-gray-900 border border-gray-500 rounded px-2 py-1 text-sm"/>
                <button id="subtitle-search-prev" class="px-2 bg-gray-600 hover:bg-gray-500 rounded" title="Trước">⟨</button>
                <button id="subtitle-search-next" class="px-2 bg-gray-600 hover:bg-gray-500 rounded" title="Sau">⟩</button>
                <button id="subtitle-search-clear" class="px-2 bg-gray-600 hover:bg-gray-500 rounded" title="Xoá">✕</button>
              </div>
            </div>
          </div>

          <!-- Row under header: select all (batch) + compare + actions (batch/reorder) -->
          <div class="px-3 py-2 bg-gray-750/50 border-b border-gray-700 flex items-center justify-between gap-2 flex-wrap">
            <div class="flex items-center gap-4">
              <div id="batch-selectall-wrap" class="hidden items-center gap-2">
                <label class="inline-flex items-center gap-2 text-sm">
                  <input id="batch-select-all" type="checkbox" class="accent-cyan-500"/>
                  <span>Chọn tất cả</span>
                </label>
              </div>
              <div id="sub-panel-compare-switch-container" class="hidden items-center space-x-2">
                <label class="text-xs">So sánh</label>
                <button id="sub-panel-compare-switch" type="button" class="relative inline-flex items-center h-6 rounded-full w-12 bg-gray-600 ring-1 ring-gray-500 transition-colors" aria-label="Bật chế độ so sánh phụ đề" aria-pressed="false">
                  <span class="sr-only">Bật chế độ so sánh phụ đề</span>
                  <span class="switch-knob inline-block w-5 h-5 transform bg-white rounded-full transition-transform translate-x-0 shadow"></span>
                </button>
              </div>
            </div>

            <div class="flex items-center gap-2">
              <button id="batch-btn" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-500 rounded text-sm" title="Chỉnh hàng loạt">Chỉnh hàng loạt</button>
              <button id="reorder-toggle" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-sm inline-flex items-center gap-2" title="Bật/Tắt kéo thả vị trí"><svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 16-4 4-4-4"/><path d="M17 20V4"/><path d="m3 8 4-4 4 4"/><path d="M7 4v16"/></svg><span>Xếp</span></button>
            </div>
          </div>
        </div>

        <button id="add-sub-line-btn" class="add-sub-fab bg-cyan-600 hover:bg-cyan-700 text-white" title="Thêm dòng phụ đề" aria-label="Thêm dòng phụ đề">+</button>

        <div id="subtitle-list" class="flex-grow p-2 min-h-0 overflow-y-auto">
          <div class="text-gray-500 text-center py-10">Chưa có phụ đề.</div>
        </div>
      </div>

      <!-- Tools panel -->
      <div id="tools-panel" class="hidden flex flex-col bg-gray-800 rounded-lg shadow-lg flex-1 lg:min-h-0">
        <div id="tools-header" class="p-3 bg-gray-700 flex justify-between items-center cursor-pointer">
          <h2 class="text-lg font-semibold">Công cụ A.I &amp; Tùy chỉnh</h2>
          <button id="toggle-tools-btn" class="hidden lg:block" aria-label="Mở rộng/Thu gọn">
            <svg id="toggle-icon" class="icon-btn-svg" viewBox="0 0 20 20">
              <path d="M5.293 12.707a1 1 0 001.414 0L10 9.414l3.293 3.293a1 1 0 001.414-1.414l-4-4a1 1 0 00-1.414 0l-4 4a1 1 0 000 1.414z"></path>
            </svg>
          </button>
        </div>

        <div id="tools-content-wrapper" class="flex-1 min-h-0 overflow-y-auto">
          <div id="tools-content" class="p-4 space-y-6">

            <div class="bg-amber-500/15 border border-amber-400 text-amber-200 p-3 rounded">
              <strong>Chú ý:</strong> Trong lúc chạy, trình duyệt có thể đứng hoặc không phản hồi. Vui lòng <strong>chờ</strong> và <strong>không thoát trang</strong>.
            </div>

            <div class="space-y-3">
              <h3 class="font-semibold flex items-center gap-2"><svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z"/><path d="M20 2v4"/><path d="M22 4h-4"/><circle cx="4" cy="20" r="2"/></svg><span>Công cụ A.I</span></h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <div>
                  <label class="text-xs font-medium" for="ai-model-select">Model A.I (Tốc độ / Chính xác)</label>
                  <select id="ai-model-select" class="w-full mt-1 bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm">
                    <option value="tiny">Tiny (Nhanh nhất)</option>
                    <option value="base" selected>Base (Cân bằng)</option>
                    <option value="small">Small (Chất lượng cao)</option>
                  </select>
                  <div id="ai-model-status" class="text-[12px] text-gray-300 mt-1">Trạng thái model: Chưa tải</div>
                </div>
                <div>
                  <label class="text-xs font-medium" for="ai-lang-select">Ngôn ngữ Video</label>
                  <input id="ai-lang-search" type="text" placeholder="Tìm ngôn ngữ..." class="w-full mt-1 bg-gray-900 border border-gray-500 rounded px-2 py-1 text-xs" aria-label="Tìm ngôn ngữ video"/>
                  <select id="ai-lang-select" class="w-full mt-1 bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm"></select>
                </div>
              </div>
              <div class="mt-3">
                <label class="text-xs font-medium" for="ui-lang-select-tools" data-ui-lang-label>Ngôn ngữ ưu tiên</label>
                <select id="ui-lang-select-tools" class="w-full mt-1 bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm">
                  <option value="vi">🇻🇳 Tiếng Việt</option>
                  <option value="en">🇺🇸 English</option>
                </select>
                <p class="text-[11px] text-gray-300 mt-1" data-ui-lang-desc>Áp dụng làm mặc định cho ngôn ngữ video và dịch.</p>
              </div>
              <button id="generate-subs-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Tạo Phụ đề từ Video (A.I.)</button>
              <div id="ai-progress-container" class="hidden mt-2">
                <div id="ai-status" class="text-xs text-center text-gray-300 mb-2">Đang khởi tạo…</div>
                <div class="progress-track"><div id="ai-progress-indet" class="progress-indet"></div></div>
              </div>
            </div>

            <hr class="border-gray-600"/>

            <!-- Translation -->
            <div id="translation-tool" class="space-y-4">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold flex items-center gap-2"><svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg><span>Dịch Thuật</span></h3>
                <div class="flex items-center gap-2">
                  <button id="prompt-advanced-btn" class="bg-sky-700 hover:bg-sky-600 text-white px-3 py-1 rounded text-sm hidden inline-flex items-center gap-2">
                  <svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 12.5 8 15l2 2.5"/><path d="m14 12.5 2 2.5-2 2.5"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"/></svg>
                  <span>Prompt nâng cao</span>
                </button>
                </div>
              </div>
              <div id="current-lang-in-tool" class="text-xs text-cyan-300"></div>

              <div>
                <label class="text-xs font-medium" for="translation-service">Dịch vụ</label>
                <select id="translation-service" class="w-full mt-1 bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm">
                  <option value="Google" selected>Google Translate</option>
                  <option value="LibreTranslate">LibreTranslate (Free)</option>
                  <option value="MyMemory">MyMemory (Free)</option>
                  <option value="DeepL">DeepL (Free API Key)</option>
                  <option value="OpenAI">OpenAI (gpt-4o-mini, API Key)</option>
                  <option value="Gemini">Google Gemini (1.5-flash, API Key)</option>
                </select>
              </div>

              <div class="lang-grid">
                <div class="lang-col">
                  <input id="source-lang-search" type="text" placeholder="Tìm ngôn ngữ nguồn..." class="w-full bg-gray-900 border border-gray-500 rounded px-2 py-1 text-xs mb-1" aria-label="Tìm ngôn ngữ nguồn"/>
                  <select id="source-language-select" class="w-full bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm" aria-label="Ngôn ngữ nguồn"></select>
                </div>
                <div class="lang-col">
                  <input id="target-lang-search" type="text" placeholder="Tìm ngôn ngữ đích..." class="w-full bg-gray-900 border border-gray-500 rounded px-2 py-1 text-xs mb-1" aria-label="Tìm ngôn ngữ đích"/>
                  <select id="target-language-select" class="w-full bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm" aria-label="Ngôn ngữ đích"></select>
                </div>
              </div>

              <!-- ADVANCED OPTIONS (only OpenAI/Gemini) -->
              <div id="adv-opts-container" class="space-y-2 bg-gray-700/40 p-3 rounded hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <label class="text-xs font-medium" for="opt-style">Phong cách</label>
                    <select id="opt-style" class="w-full bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm">
                      <option value="neutral" selected>Trung tính</option>
                      <option value="formal">Trang trọng</option>
                      <option value="casual">Đời thường</option>
                      <option value="creative">Sáng tạo tự nhiên</option>
                    </select>
                  </div>
                  <div>
                    <label class="text-xs font-medium" for="opt-literalness">Mức sát nghĩa</label>
                    <select id="opt-literalness" class="w-full bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm">
                      <option value="balanced" selected>Cân bằng</option>
                      <option value="literal">Sát nghĩa</option>
                      <option value="free">Tự do/giữ ý</option>
                    </select>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <label class="inline-flex items-center gap-2 text-sm"><input id="opt-context" type="checkbox" class="accent-cyan-500"/><span>Hiểu ngữ cảnh đoạn (dùng toàn bộ file sub cho OpenAI/Gemini)</span></label>
                  <label class="inline-flex items-center gap-2 text-sm"><input id="opt-slang" type="checkbox" class="accent-cyan-500"/><span>Giữ tiếng lóng/khẩu ngữ</span></label>
                </div>
                <div>
                  <label class="text-xs font-medium" for="opt-glossary">Thuật ngữ (mỗi dòng 1 cặp “gốc=đích”)</label>
                  <textarea id="opt-glossary" rows="2" class="w-full mt-1 bg-gray-900 border border-gray-500 rounded px-2 py-1 text-sm" placeholder="VD: Sài Gòn=Ho Chi Minh City"></textarea>
                </div>
                <div class="flex items-center gap-2">
                  <input id="opt-use-custom-prompt" type="checkbox" class="accent-cyan-500"/>
                  <label for="opt-use-custom-prompt" class="text-sm">Sử dụng prompt tùy chỉnh</label>
                </div>
              </div>

              <div id="api-key-container" class="hidden">
                <label id="api-key-label" class="text-xs font-medium" for="api-key-input">API Key</label>
                <div class="mt-1 flex items-stretch gap-2">
                  <input id="api-key-input" type="password" placeholder="dán API key của bạn vào đây" class="flex-1 bg-gray-900 border border-gray-500 rounded px-2 py-1 text-sm"/>
                  <button id="toggle-api-visibility" class="bg-gray-600 hover:bg-gray-500 text-white rounded px-3 inline-flex items-center justify-center gap-2" title="Hiện/ẩn API key" aria-label="Hiện/ẩn API key"><span class="sr-only">Hiện hoặc ẩn API key</span><svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/></svg></button>
                </div>
                <div class="text-[11px] text-gray-400 mt-1">API key sẽ được lưu vào cookie riêng theo từng dịch vụ.</div>
              </div>

              <div class="flex items-center justify-end gap-3">
                <div id="loading-spinner" class="spinner hidden"></div>
                <div id="translate-progress" class="text-xs text-gray-300"></div>
                <button id="translate-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Dịch</button>
              </div>
            </div>

            <hr class="border-gray-600"/>

            <!-- Bulk Find & Replace -->
            <div id="bulk-find-replace" class="space-y-3">
              <h3 class="font-semibold flex items-center gap-2"><svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 4a2 2 0 0 1 2-2"/><path d="M16 10a2 2 0 0 1-2-2"/><path d="M20 2a2 2 0 0 1 2 2"/><path d="M22 8a2 2 0 0 1-2 2"/><path d="m3 7 3 3 3-3"/><path d="M6 10V5a3 3 0 0 1 3-3h1"/><rect x="2" y="14" width="8" height="8" rx="2"/></svg><span>Tìm kiếm &amp; Thay thế hàng loạt</span></h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div><label class="text-xs font-medium" for="fr-find">Chuỗi cần tìm</label>
                  <input id="fr-find" type="text" class="w-full mt-1 bg-gray-900 border border-gray-500 rounded px-2 py-1 text-sm" placeholder="vd: không"/>
                </div>
                <div><label class="text-xs font-medium" for="fr-replace">Thay thế bằng</label>
                  <input id="fr-replace" type="text" class="w-full mt-1 bg-gray-900 border border-gray-500 rounded px-2 py-1 text-sm" placeholder="vd: ko"/>
                </div>
              </div>
              <div class="flex flex-wrap items-center gap-4 text-sm">
                <label class="inline-flex items-center gap-2"><input id="fr-case" type="checkbox" class="accent-cyan-500"><span>Phân biệt hoa/thường</span></label>
                <label class="inline-flex items-center gap-2"><input id="fr-whole" type="checkbox" class="accent-cyan-500"><span>Khớp từ riêng</span></label>
              </div>
              <div class="flex items-center gap-2">
                <button id="fr-count-btn" class="bg-gray-600 hover:bg-gray-500 text-white px-3 py-2 rounded text-sm">Đếm kết quả</button>
                <button id="fr-replace-all-btn" class="bg-rose-600 hover:bg-rose-700 text-white px-3 py-2 rounded text-sm">Thay thế tất cả</button>
                <div id="fr-result" class="text-xs text-gray-300 ml-2"></div>
              </div>
            </div>

            <hr class="border-gray-600"/>

            <!-- Subtitle appearance -->
            <div class="space-y-3">
              <h3 class="font-semibold flex items-center gap-2"><svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="14" x="3" y="5" rx="2" ry="2"/><path d="M7 15h4M15 15h2M7 11h2M13 11h4"/></svg><span>Tùy chỉnh hiển thị phụ đề</span></h3>
              <div class="grid grid-cols-2 gap-4">
                <div><label class="text-xs font-medium" for="sub-text-color">Màu chữ</label>
                  <input id="sub-text-color" type="color" value="#FFFFFF" class="w-full mt-1 h-8 p-0 border-none rounded cursor-pointer"/>
                </div>
                <div><label class="text-xs font-medium" for="sub-bg-color">Màu nền</label>
                  <input id="sub-bg-color" type="color" value="#000000" class="w-full mt-1 h-8 p-0 border-none rounded cursor-pointer"/>
                </div>
              </div>
              <div><label class="text-xs font-medium" for="sub-font-size">Cỡ chữ: <span id="font-size-label">24</span>px</label>
                <input id="sub-font-size" type="range" min="12" max="60" value="24" class="w-full mt-1"/></div>
              <div><label class="text-xs font-medium" for="sub-bottom-pos">Vị trí (từ đáy): <span id="bottom-pos-label">20</span>px</label>
                <input id="sub-bottom-pos" type="range" min="10" max="200" value="20" class="w-full mt-1"/></div>
              <div class="pt-2 border-t border-gray-700">
                <label class="text-xs font-medium" for="ui-lang-select-bottom" data-ui-lang-label>Ngôn ngữ ưu tiên</label>
                <select id="ui-lang-select-bottom" class="w-full mt-1 bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm">
                  <option value="vi">🇻🇳 Tiếng Việt</option>
                  <option value="en">🇺🇸 English</option>
                </select>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- SCRIPT -->
  <script type="module">
    import { pipeline, env } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1";
    env.allowLocalModels = true;
    env.useBrowserCache = true;
    env.cacheDir = './.cache';

    /* ===== Elements ===== */
    const headerEl = document.getElementById('top-header');
    const headerToggle = document.getElementById('header-toggle');

    const videoPlayer = document.getElementById('video-player');
    const videoInput = document.getElementById('video-input');
    const videoPlaceholderContainer = document.getElementById('video-placeholder-container');
    const videoPlaceholder = document.getElementById('video-placeholder');
    const videoWrapper = document.getElementById('video-wrapper');
    const dragOverlay = document.getElementById('drag-overlay');

    const subtitleInput = document.getElementById('subtitle-input');
    const subtitleList = document.getElementById('subtitle-list');
    const subtitleOverlay = document.getElementById('subtitle-overlay');

    const playPauseBtn = document.getElementById('play-pause-btn');
    const stopBtn = document.getElementById('stop-btn');
    const infoBtn = document.getElementById('info-btn');

    const timeline = document.getElementById('timeline');
    const timeDisplay = document.getElementById('time-display');
    const volumeSlider = document.getElementById('volume-slider');
    const muteBtn = document.getElementById('mute-btn');
    const fullscreenBtn = document.getElementById('fullscreen-btn');

    const playIconEl = playPauseBtn?.querySelector('[data-icon="play"]');
    const pauseIconEl = playPauseBtn?.querySelector('[data-icon="pause"]');
    const volumeOnIcon = muteBtn?.querySelector('[data-icon="volume-on"]');
    const volumeOffIcon = muteBtn?.querySelector('[data-icon="volume-off"]');

    function syncPlayPauseIcon(){
      if(!playPauseBtn || !playIconEl || !pauseIconEl) return;
      const isPlaying = !(videoPlayer.paused || videoPlayer.ended);
      playIconEl.classList.toggle('hidden', isPlaying);
      pauseIconEl.classList.toggle('hidden', !isPlaying);
    }

    function syncMuteIcon(){
      if(!muteBtn || !volumeOnIcon || !volumeOffIcon) return;
      const muted = videoPlayer.muted || videoPlayer.volume === 0;
      volumeOnIcon.classList.toggle('hidden', muted);
      volumeOffIcon.classList.toggle('hidden', !muted);
      muteBtn.setAttribute('aria-pressed', muted ? 'true' : 'false');
    }


    const saveSrtBtn = document.getElementById('save-srt');
    const modalContainer = document.getElementById('modal-container');

    const tabSubs = document.getElementById('tab-subs');
    const tabTools = document.getElementById('tab-tools');
    const rightPanel = document.getElementById('right-panel');
    const subtitlePanel = document.getElementById('subtitle-panel');
    const subtitleHeader = document.getElementById('subtitle-header');
    const subtitleHeaderWrap = document.getElementById('subtitle-header-wrap');
    const toolsPanel = document.getElementById('tools-panel');
    const toolsHeader = document.getElementById('tools-header');
    const toggleIcon = document.getElementById('toggle-icon');
    const toolsContentWrapper = document.getElementById('tools-content-wrapper');

    const generateSubsBtn = document.getElementById('generate-subs-btn');
    const aiModelSelect = document.getElementById('ai-model-select');
    const aiModelStatus = document.getElementById('ai-model-status');
    const aiLangSelect = document.getElementById('ai-lang-select');
    const aiLangSearch = document.getElementById('ai-lang-search');
    const aiProgressContainer = document.getElementById('ai-progress-container');
    const aiStatus = document.getElementById('ai-status');

    const translateBtn = document.getElementById('translate-btn');
    const translationServiceSelect = document.getElementById('translation-service');
    const sourceLanguageSelect = document.getElementById('source-language-select');
    const targetLanguageSelect = document.getElementById('target-language-select');
    const sourceLangSearch = document.getElementById('source-lang-search');
    const targetLangSearch = document.getElementById('target-lang-search');
    const uiLangSelectTools = document.getElementById('ui-lang-select-tools');
    const uiLangSelectBottom = document.getElementById('ui-lang-select-bottom');
    const apiKeyContainer = document.getElementById('api-key-container');
    const uiLanguageSelectors = [];
    if(uiLangSelectTools) uiLanguageSelectors.push(uiLangSelectTools);
    if(uiLangSelectBottom) uiLanguageSelectors.push(uiLangSelectBottom);
    const apiKeyLabel = document.getElementById('api-key-label');
    const apiKeyInput = document.getElementById('api-key-input');
    const toggleApiVisibilityBtn = document.getElementById('toggle-api-visibility');
    const loadingSpinner = document.getElementById('loading-spinner');
    const translateProgress = document.getElementById('translate-progress');

    const subtitleLangDisplay = document.getElementById('subtitle-lang-display');
    const currentLangInTool = document.getElementById('current-lang-in-tool');
    const subPanelCompareSwitchContainer = document.getElementById('sub-panel-compare-switch-container');
    const subPanelCompareSwitch = document.getElementById('sub-panel-compare-switch');
    const addSubLineBtn = document.getElementById('add-sub-line-btn');

    const subTextColorInput = document.getElementById('sub-text-color');
    const subBgColorInput = document.getElementById('sub-bg-color');
    const subFontSizeInput = document.getElementById('sub-font-size');
    const subBottomPosInput = document.getElementById('sub-bottom-pos');
    const fontSizeLabel = document.getElementById('font-size-label');
    const bottomPosLabel = document.getElementById('bottom-pos-label');

    const notificationContainer = document.getElementById('notification-container');

    const subtitleSearchInput = document.getElementById('subtitle-search-input');
    const subtitleSearchPrevBtn = document.getElementById('subtitle-search-prev');
    const subtitleSearchNextBtn = document.getElementById('subtitle-search-next');
    const subtitleSearchClearBtn = document.getElementById('subtitle-search-clear');
    let searchHits = [];
    let currentHitIdx = -1;

    const frFind = document.getElementById('fr-find');
    const frReplace = document.getElementById('fr-replace');
    const frCase = document.getElementById('fr-case');
    const frWhole = document.getElementById('fr-whole');
    const frCountBtn = document.getElementById('fr-count-btn');
    const frReplaceAllBtn = document.getElementById('fr-replace-all-btn');
    const frResult = document.getElementById('fr-result');

    const reorderToggle = document.getElementById('reorder-toggle');
    const batchBtn = document.getElementById('batch-btn');
    const batchSelectAllWrap = document.getElementById('batch-selectall-wrap');
    const batchSelectAll = document.getElementById('batch-select-all');
    let reorderMode = false;
    let batchMode = false;
    let selectedRows = new Set();
    let dragFromIndex = -1;

    let subtitles = [], originalSubtitles = [];
    let currentSubtitleIndex = -1, currentSubLang = "Chưa xác định", currentSubLangCode = "unk";
    let transcriber = null, currentModel = null;
    let isVideoLoaded = false, areSubsLoaded = false, isComparing = false;
    let videoFile = null;
    let isCustomFullscreen = false;
    let isDirty = false;

    const loadedModels = new Set();
    const UI_LANGUAGE_KEY = 'ui_language_pref';
    const DEFAULT_UI_LANGUAGE = 'vi';
    const UI_LANGUAGE_DISPLAY = {
      vi: { label: 'Tiếng Việt', flag: '🇻🇳' },
      en: { label: 'English', flag: '🇺🇸' }
    };
    const LANGUAGE_LABEL_OVERRIDES = {
      vi: { auto: 'Tự động phát hiện', vi: 'Tiếng Việt', en: 'Tiếng Anh' },
      en: { auto: 'Auto detect', vi: 'Vietnamese', en: 'English' }
    };
    const FLAG_OVERRIDES = {
      auto: '🌐', en: '🇺🇸', vi: '🇻🇳', zh: '🇨🇳', 'zh-CN': '🇨🇳', 'zh-TW': '🇹🇼',
      pt: '🇵🇹', 'pt-BR': '🇧🇷', es: '🇪🇸', fr: '🇫🇷', de: '🇩🇪', ja: '🇯🇵', ko: '🇰🇷', ru: '🇷🇺',
      ar: '🇸🇦', hi: '🇮🇳', id: '🇮🇩', ms: '🇲🇾', th: '🇹🇭', tr: '🇹🇷', uk: '🇺🇦', it: '🇮🇹',
      pl: '🇵🇱', nl: '🇳🇱', sv: '🇸🇪', da: '🇩🇰', fi: '🇫🇮', no: '🇳🇴', cs: '🇨🇿', sk: '🇸🇰',
      ro: '🇷🇴', bg: '🇧🇬', el: '🇬🇷', hu: '🇭🇺', sq: '🇦🇱', hr: '🇭🇷', sr: '🇷🇸', sl: '🇸🇮',
      lt: '🇱🇹', lv: '🇱🇻', et: '🇪🇪', is: '🇮🇸', ga: '🇮🇪', mk: '🇲🇰', bs: '🇧🇦', az: '🇦🇿',
      ky: '🇰🇬', kk: '🇰🇿', uz: '🇺🇿', fa: '🇮🇷', ur: '🇵🇰', ps: '🇦🇫', bn: '🇧🇩', ta: '🇮🇳',
      te: '🇮🇳', kn: '🇮🇳', ml: '🇮🇳', mr: '🇮🇳', pa: '🇮🇳', gu: '🇮🇳', si: '🇱🇰', ne: '🇳🇵',
      lo: '🇱🇦', km: '🇰🇭', my: '🇲🇲', tl: '🇵🇭', su: '🇮🇩', sw: '🇰🇪', xh: '🇿🇦', zu: '🇿🇦',
      af: '🇿🇦', st: '🇱🇸', yo: '🇳🇬', ig: '🇳🇬', ha: '🇳🇬', am: '🇪🇹', haw: '🇺🇸', fy: '🇳🇱',
      gl: '🇪🇸', eu: '🇪🇸', ca: '🇪🇸', co: '🇫🇷', ny: '🇲🇼', sm: '🇼🇸', gd: '🇬🇧', cy: '🇬🇧',
      eo: '🌐', la: '🇻🇦', lb: '🇱🇺', mg: '🇲🇬', mt: '🇲🇹', mi: '🇳🇿', ht: '🇭🇹', rw: '🇷🇼',
      so: '🇸🇴', tg: '🇹🇯', tk: '🇹🇲', tt: '🇷🇺', ug: '🇨🇳', hy: '🇦🇲', be: '🇧🇾', ka: '🇬🇪'
    };
    const storedUILanguage = localStorage.getItem(UI_LANGUAGE_KEY);
    let preferredUILanguage = storedUILanguage || DEFAULT_UI_LANGUAGE;
    const hasStoredLanguage = !!storedUILanguage;

    const LANGUAGES = {
      "auto":"Tự động phát hiện","af":"Afrikaans","sq":"Albanian","am":"Amharic","ar":"Arabic","hy":"Armenian","az":"Azerbaijani","eu":"Basque","be":"Belarusian","bn":"Bengali","bs":"Bosnian","bg":"Bulgarian","ca":"Catalan","ceb":"Cebuano","ny":"Chichewa","zh":"Chinese","zh-CN":"Chinese (Simplified)","zh-TW":"Chinese (Traditional)","co":"Corsican","hr":"Croatian","cs":"Czech","da":"Danish","nl":"Dutch","en":"English","eo":"Esperanto","et":"Estonian","tl":"Filipino","fi":"Finnish","fr":"French","fy":"Frisian","gl":"Galician","ka":"Georgian","de":"German","el":"Greek","gu":"Gujarati","ht":"Haitian Creole","ha":"Hausa","haw":"Hawaiian","he":"Hebrew","hi":"Hindi","hmn":"Hmong","hu":"Hungarian","is":"Icelandic","ig":"Igbo","id":"Indonesian","ga":"Irish","it":"Italian","ja":"Japanese","jv":"Javanese","kn":"Kannada","kk":"Kazakh","km":"Khmer","rw":"Kinyarwanda","ko":"Korean","ku":"Kurdish (Kurmanji)","ky":"Kyrgyz","lo":"Lao","la":"Latin","lv":"Latvian","lt":"Lithuanian","lb":"Luxembourgish","mk":"Macedonian","mg":"Malagasy","ms":"Malay","ml":"Malayalam","mt":"Maltese","mi":"Maori","mr":"Marathi","mn":"Mongolian","my":"Myanmar (Burmese)","ne":"Nepali","no":"Norwegian","or":"Odia (Oriya)","ps":"Pashto","fa":"Persian","pl":"Polish","pt":"Portuguese","pa":"Punjabi","ro":"Romanian","ru":"Russian","sm":"Samoan","gd":"Scots Gaelic","sr":"Serbian","st":"Sesotho","sn":"Shona","sd":"Sindhi","si":"Sinhala","sk":"Slovak","sl":"Slovenian","so":"Somali","es":"Spanish","su":"Sundanese","sw":"Swahili","sv":"Swedish","tg":"Tajik","ta":"Tamil","tt":"Tatar","te":"Telugu","th":"Thai","tr":"Turkish","tk":"Turkmen","uk":"Ukrainian","ur":"Urdu","ug":"Uyghur","uz":"Uzbek","vi":"Vietnamese","cy":"Welsh","xh":"Xhosa","yi":"Yiddish","yo":"Yoruba","zu":"Zulu"
    };
    window.LANGUAGES = LANGUAGES;

    /* ===== Utils ===== */
    function showNotification(message, type='success', duration=5000){
      const n=document.createElement('div'); n.className=`notification ${type}`; n.textContent=message;
      notificationContainer.appendChild(n); setTimeout(()=>n.classList.add('show'),10);
      setTimeout(()=>{ n.classList.remove('show'); setTimeout(()=>n.remove(),500); }, duration);
    }
    function hexToRgba(hex, alpha){ const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; }
    function timeToSeconds(str){ const p=str.split(':'), s=p[2].split(','); return (+p[0])*3600 + (+p[1])*60 + (+s[0]) + (+s[1])/1000; }
    function secondsToTime(t){ if(isNaN(t)) return '00:00:00,000'; const h=String(Math.floor(t/3600)).padStart(2,'0'); const m=String(Math.floor((t%3600)/60)).padStart(2,'0'); const s=String(Math.floor(t%60)).padStart(2,'0'); const ms=String(Math.round((t-Math.floor(t))*1000)).padStart(3,'0'); return `${h}:${m}:${s},${ms}`; }
    function formatTime(s){ if(isNaN(s)) return '00:00:00'; return new Date(s*1000).toISOString().substr(11,8); }
    function getFlagEmojiForLang(code){
      if(!code) return '🌐';
      const exact = FLAG_OVERRIDES[code] || FLAG_OVERRIDES[code.toLowerCase()];
      if(exact) return exact;
      const normalized = code.includes('-') ? code.split('-').pop().toUpperCase() : code.toUpperCase();
      if(/^[A-Z]{2}$/.test(normalized)){
        const points = Array.from(normalized).map(c => 127397 + c.charCodeAt(0));
        return String.fromCodePoint(...points);
      }
      return '🌐';
    }
    function getLanguageNameForUI(code){
      const overrides = LANGUAGE_LABEL_OVERRIDES[preferredUILanguage] || {};
      return overrides[code] || LANGUAGES[code] || code.toUpperCase();
    }
    function getLanguageDisplay(code){
      const name = getLanguageNameForUI(code);
      const flag = getFlagEmojiForLang(code);
      return { text: `${flag} ${name}`.trim(), label: name };
    }
    function ensureSelectHasValue(select, value){
      if(!select) return;
      const option = Array.from(select.options).find(o=>o.value===value);
      if(option) select.value = value;
    }
    function refreshLanguageSelect(select){
      if(!select) return;
      Array.from(select.options).forEach(opt=>{
        const display = getLanguageDisplay(opt.value);
        opt.textContent = display.text;
        opt.dataset.label = display.label.toLowerCase();
      });
    }
    function refreshAllLanguageSelects(){
      refreshLanguageSelect(aiLangSelect);
      refreshLanguageSelect(sourceLanguageSelect);
      refreshLanguageSelect(targetLanguageSelect);
    }
    function updateUiLanguageSelectOptions(){
      uiLanguageSelectors.forEach(sel=>{
        if(!sel) return;
        Array.from(sel.options).forEach(opt=>{
          const display = UI_LANGUAGE_DISPLAY[(opt.value || '').toLowerCase()];
          if(display) opt.textContent = display.flag + ' ' + display.label;
        });
      });
    }
    function syncUiLanguageSelectors(){
      uiLanguageSelectors.forEach(sel=>{
        if(sel && sel.value !== preferredUILanguage) sel.value = preferredUILanguage;
      });
    }
    function applyLanguageOptionDefaults(){
      ensureSelectHasValue(aiLangSelect, preferredUILanguage);
      ensureSelectHasValue(targetLanguageSelect, preferredUILanguage);
      if(currentLangInTool){
        const display = getLanguageDisplay(preferredUILanguage);
        const prefix = preferredUILanguage === 'en' ? 'Default target language: ' : 'Ngôn ngữ đích mặc định: ';
        currentLangInTool.innerHTML = prefix + display.text;
      }
      if(aiLangSearch){
        aiLangSearch.placeholder = preferredUILanguage === 'en' ? 'Search language...' : 'Tìm ngôn ngữ...';
        aiLangSearch.setAttribute('aria-label', preferredUILanguage === 'en' ? 'Search video language' : 'Tìm ngôn ngữ video');
      }
      if(sourceLangSearch){
        sourceLangSearch.placeholder = preferredUILanguage === 'en' ? 'Search source language...' : 'Tìm ngôn ngữ nguồn...';
        sourceLangSearch.setAttribute('aria-label', preferredUILanguage === 'en' ? 'Search source language' : 'Tìm ngôn ngữ nguồn');
      }
      if(targetLangSearch){
        targetLangSearch.placeholder = preferredUILanguage === 'en' ? 'Search target language...' : 'Tìm ngôn ngữ đích...';
        targetLangSearch.setAttribute('aria-label', preferredUILanguage === 'en' ? 'Search target language' : 'Tìm ngôn ngữ đích');
      }
      document.querySelectorAll('[data-ui-lang-label]').forEach(label=>{
        label.textContent = preferredUILanguage === 'en' ? 'Preferred language' : 'Ngôn ngữ ưu tiên';
      });
      document.querySelectorAll('[data-ui-lang-desc]').forEach(desc=>{
        desc.textContent = preferredUILanguage === 'en'
          ? 'Apply as default for video and translation languages.'
          : 'Áp dụng làm mặc định cho ngôn ngữ video và dịch.';
      });
    }
    function setPreferredLanguage(lang, options={}){
      const candidate = (lang || '').toLowerCase();
      const normalized = UI_LANGUAGE_DISPLAY[candidate] ? candidate : DEFAULT_UI_LANGUAGE;
      preferredUILanguage = normalized;
      if(!options.skipPersist){
        localStorage.setItem(UI_LANGUAGE_KEY, normalized);
      }
      updateUiLanguageSelectOptions();
      syncUiLanguageSelectors();
      refreshAllLanguageSelects();
      applyLanguageOptionDefaults();
    }
    function showUiLanguageModal(){
      const buttons = Object.entries(UI_LANGUAGE_DISPLAY).map(([value, info])=>
        `<button class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded flex-1" data-lang="${value}">${info.flag} ${info.label}</button>`
      ).join('<div class="h-3"></div>');
      showModal(`
        <div class="modal-content space-y-4">
          <div class="text-base font-semibold text-center">Chọn ngôn ngữ ưu tiên</div>
          <p class="text-sm text-gray-300 text-center">Bạn có thể thay đổi lại trong mục Công cụ A.I hoặc phần Tùy chỉnh phía dưới.</p>
          <div class="flex flex-col gap-3">${buttons}</div>
        </div>
      `, (modal)=>{
        modal.querySelectorAll('[data-lang]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const lang = btn.dataset.lang;
            setPreferredLanguage(lang);
            modal.remove();
            showNotification('Đã thiết lập ngôn ngữ ưu tiên.', 'success', 2200);
          });
        });
      });
    }

    function updateSubLangDisplay(lang, code){ currentSubLang=lang; if(code) currentSubLangCode=code; const a=document.getElementById('subtitle-lang-display'); const b=document.getElementById('current-lang-in-tool'); if(a) a.textContent=`Ngôn ngữ hiện tại: ${currentSubLang}`; if(b) b.textContent=`Ngôn ngữ hiện tại của phụ đề: ${currentSubLang}`; }
    function setSubsHeaderHeightVar(){ const wrap=document.getElementById('subtitle-header-wrap'); if(!wrap) return; const h=wrap.getBoundingClientRect().height||56; document.documentElement.style.setProperty('--subs-header-h', `${Math.round(h)}px`); }
    function setVHVar(){ const vh = window.innerHeight * 0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); }
    setVHVar(); window.addEventListener('resize', setVHVar); window.addEventListener('orientationchange', setVHVar);

    /* Cookies API key */
    function setCookie(name, value, days=365){ const d=new Date(); d.setTime(d.getTime()+days*24*60*60*1000); document.cookie=`${encodeURIComponent(name)}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/;SameSite=Lax`; }
    function getCookie(name){ const cname=encodeURIComponent(name)+"="; const parts=document.cookie.split('; '); for(const p of parts){ if(p.indexOf(cname)===0) return decodeURIComponent(p.substring(cname.length)); } return ''; }
    function cookieKeyForService(svc){ return `apiKey_${svc}`; }
    function loadApiKeyForService(svc){ const val=getCookie(cookieKeyForService(svc)); const inp=document.getElementById('api-key-input'); if(inp) inp.value = val || ''; }
    function saveApiKeyForCurrentService(){ const svc=translationServiceSelect.value; const inp=document.getElementById('api-key-input'); if(!inp) return; if(['OpenAI','DeepL','Gemini'].includes(svc) && inp.value){ setCookie(cookieKeyForService(svc), inp.value); } }

    function markDirty(){ isDirty = true; const b=document.getElementById('save-srt'); b&&b.classList.add('unsaved-glow'); try{ if(typeof scheduleAutosave==='function') scheduleAutosave(); }catch{} }
    function clearDirty(){ isDirty = false; const b=document.getElementById('save-srt'); b&&b.classList.remove('unsaved-glow'); }

    /* Modal helpers */
    function showModal(html, cb){ const m=document.createElement('div'); m.className='modal-overlay'; m.innerHTML=html; m.querySelectorAll('.close-modal-btn,.cancel-btn').forEach(b=>b.onclick=()=>m.remove()); modalContainer.innerHTML=''; modalContainer.appendChild(m); cb&&cb(m); }
    function showConfirmModal(message, onConfirm, onCancel){ showModal(
      `<div class="modal-content space-y-4"><div class="text-sm">${message}</div>
        <div class="flex justify-end space-x-3">
          <button class="cancel-btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Hủy</button>
          <button class="confirm-btn bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Xác nhận</button>
        </div></div>`,
      (m)=>{ m.querySelector('.confirm-btn').onclick=()=>{ onConfirm&&onConfirm(); m.remove(); };
             if(onCancel){ m.querySelector('.cancel-btn').onclick=()=>{ onCancel(); m.remove(); }; } }
    ); }

    /* Header toggle */
    headerToggle?.addEventListener('click', ()=>{ headerEl?.classList.toggle('collapsed'); const c=headerEl?.classList.contains('collapsed'); const ic=headerToggle.querySelector('.toggle-ico'); if(ic) ic.textContent=c?'▾':'▴'; });

    /* Player */
    function togglePlayPause(){ if(videoPlayer.src){ (videoPlayer.paused||videoPlayer.ended)?videoPlayer.play():videoPlayer.pause(); syncPlayPauseIcon(); } }
    function customFullscreenToggle(){ isCustomFullscreen=!isCustomFullscreen; document.body.classList.toggle('custom-fs', isCustomFullscreen); if(isCustomFullscreen) { setVHVar(); window.scrollTo({ top:0, behavior:'instant' }); } }
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && isCustomFullscreen){ customFullscreenToggle(); } });
    function showVideoInfo(){
      if(!videoFile || !videoPlayer.videoWidth) return showNotification('Vui lòng tải video để xem thông tin.','warning');
      const gcd=(a,b)=> b===0?a:gcd(b,a%b); const ratio=gcd(videoPlayer.videoWidth, videoPlayer.videoHeight);
      const sizeMB=(videoFile.size/1024/1024).toFixed(2);
      showModal(`<div class="modal-content space-y-3">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-bold text-cyan-400 flex items-center gap-2"><svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg><span>Thông tin Video</span></h3>
          <button class="close-modal-btn font-bold text-2xl">&times;</button>
        </div>
        <div class="text-sm space-y-2">
          <p><strong>Tên file:</strong> ${videoFile.name}</p>
          <p><strong>Định dạng (MIME):</strong> ${videoFile.type}</p>
          <p><strong>Dung lượng:</strong> ${sizeMB} MB</p>
          <p><strong>Độ phân giải:</strong> ${videoPlayer.videoWidth} x ${videoPlayer.videoHeight} pixels</p>
          <p><strong>Tỷ lệ khung hình:</strong> ${videoPlayer.videoWidth/ratio}:${videoPlayer.videoHeight/ratio}</p>
          <p><strong>Ngày chỉnh sửa:</strong> ${new Date(videoFile.lastModified).toLocaleString('vi-VN')}</p>
        </div>
        <p class="text-xs text-gray-400 pt-2">Lưu ý: Thông tin dựa theo dữ liệu video trên máy tính của bạn, chúng tôi không lưu trữ hoặc tải lên bất kỳ video nào.</p>
      </div>`);
    }

    /* Subtitle IO + formats */
    function parseSRT(s){ return s.trim().split(/\n\s*\n/).map(b=>{ const lines=b.split('\n'); if(lines.length<2) return null; const t=lines.find(l=>l.includes('-->')); if(!t) return null; const txt=lines.slice(lines.indexOf(t)+1); const [st,et]=t.split(' --> '); return { startTime: timeToSeconds(st), endTime: timeToSeconds(et), text: txt.join('\n') }; }).filter(Boolean); }
    function parseVTT(s){
      const lines=s.replace(/\r/g,'').split('\n').filter(l=>l.trim()!=='WEBVTT');
      const blocks=lines.join('\n').trim().split(/\n\s*\n/);
      const out=[];
      for(const b of blocks){
        const ls=b.split('\n'); const timeLine=ls.find(l=>l.includes('-->')); if(!timeLine) continue;
        const [st,et]=timeLine.split(' --> ').map(x=>x.replace('.',',')); 
        const txt=ls.slice(ls.indexOf(timeLine)+1).join('\n');
        out.push({ startTime: timeToSeconds(st), endTime: timeToSeconds(et), text: txt });
      }
      return out;
    }
    function parseASSTime(t){
      const parts=t.trim().split(':');
      if(parts.length<3) return 0;
      const h=+parts[0], m=+parts[1];
      const ss=parts[2].split('.');
      const s=+ss[0]; const cs=+(ss[1]||'0');
      return h*3600 + m*60 + s + cs/100;
    }
    function stripASSTags(text){ return text.replace(/\{[^}]*\}/g,'').replace(/\\N/gi,'\n'); }
    function parseASS(s){
      const lines=s.replace(/\r/g,'').split('\n');
      let fmt=[]; let inEvents=false; const out=[];
      for(const raw of lines){
        const line=raw.trim();
        if(line.startsWith('[')){ inEvents=(line.toLowerCase()==='[events]'); continue; }
        if(!inEvents) continue;
        if(line.toLowerCase().startsWith('format:')){ fmt=line.substring(7).split(',').map(x=>x.trim().toLowerCase()); continue; }
        if(line.toLowerCase().startsWith('dialogue:')){
          const data=line.substring(9).split(',');
          const m={};
          for(let i=0;i<fmt.length && i<data.length;i++){ m[fmt[i]]=data[i]; }
          if(data.length>fmt.length){ m['text']=data.slice(fmt.length-1).join(','); }
          const st=m['start']||m['start time']||data[1];
          const et=m['end']||m['end time']||data[2];
          const txt=stripASSTags(m['text']||'');
          if(st&&et) out.push({ startTime: parseASSTime(st), endTime: parseASSTime(et), text: txt });
        }
      }
      return out;
    }
    function baseNameNoExt(name){ const i=name.lastIndexOf('.'); return i>0?name.substring(0,i):name; }
    function saveSRTFile(){
      if(!subtitles.length) return showNotification('Không có phụ đề để lưu.','warning');
      const srt=subtitles.map((s,i)=>`${i+1}\n${secondsToTime(s.startTime)} --> ${secondsToTime(s.endTime)}\n${s.text}`).join('\n\n');
      const blob=new Blob([srt],{type:'text/plain;charset=utf-8'});
      const videoBase=videoFile?baseNameNoExt(videoFile.name):'subtitles';
      const code=currentSubLangCode||'unk';
      const filename=`${videoBase}_${code}.srt`;
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href);
      clearDirty();
      showNotification(`Đã lưu: ${filename}`,'success');
    }
    function proceedOpenSubFile(file){
      const name=file.name.toLowerCase();
      const r=new FileReader();
      r.onload=(ev)=>{
        let parsed=[];
        if(name.endsWith('.srt')) parsed=parseSRT(ev.target.result);
        else if(name.endsWith('.vtt')) parsed=parseVTT(ev.target.result);
        else if(name.endsWith('.ass')||name.endsWith('.ssa')) parsed=parseASS(ev.target.result);
        else { showNotification('Định dạng sub chưa hỗ trợ đầy đủ (chỉ SRT/VTT).','warning'); return; }
        subtitles=parsed;
        originalSubtitles=JSON.parse(JSON.stringify(subtitles));
        displaySubtitles();
        updateSubLangDisplay('Chưa xác định (vừa tải lên)','unk');
        areSubsLoaded=true; clearDirty();
        checkDurations(); applySearchHighlights();
      };
      r.readAsText(file,'UTF-8');
    }
    function handleSubtitleInput(e){
      const file=e.target.files[0]; if(!file) return;
      if(isDirty && subtitles.length){
        showConfirmModal('Bạn có thay đổi phụ đề chưa lưu. Mở sub mới sẽ làm mất các thay đổi. Tiếp tục?',
          ()=>{ proceedOpenSubFile(file); },
          ()=>{ subtitleInput.value=''; }
        );
      } else proceedOpenSubFile(file);
    }

    function scrollToSubtitleIndex(i){
      const row = document.getElementById(`sub-${i}`);
      if(!row) return;
      const container = subtitleList;
      const top = row.offsetTop - (container.firstElementChild?.offsetTop || 0);
      const padding = 24;
      const targetTop = Math.max(0, top - padding);
      container.scrollTo({ top: targetTop, behavior: 'smooth' });
      row.classList.add('flash-highlight');
      setTimeout(()=>row.classList.remove('flash-highlight'), 2200);
    }

    function resortSubtitlesByTime(){
      const withIndex=subtitles.map((s,i)=>({s,i}));
      withIndex.sort((a,b)=>a.s.startTime-b.s.startTime);
      subtitles=withIndex.map(x=>x.s);
      displaySubtitles();
    }

    /* ===== Virtualized render for very large lists ===== */
    function displaySubtitlesVirtualized(){
      if(!subtitleList) return;
      if(!subtitles.length){ subtitleList.innerHTML=`<div class="text-gray-500 text-center py-10">Không có dữ liệu phụ đề.</div>`; return; }
      const BUFFER = 10;
      if(!subtitleList._vs){
        subtitleList._vs = { rowH: 68, measured: false };
        subtitleList.addEventListener('scroll', ()=> displaySubtitlesVirtualized());
      }
      const vs = subtitleList._vs;
      if(!vs.measured){
        // quick measure
        const probe=document.createElement('div'); probe.className='subtitle-item p-2 mb-2 bg-gray-700 rounded-lg text-sm'; probe.style.visibility='hidden'; probe.textContent='Đo chiều cao'; subtitleList.innerHTML=''; subtitleList.appendChild(probe); vs.rowH = Math.max(48, probe.offsetHeight||68); vs.measured=true; subtitleList.innerHTML='';
      }
      const ch = subtitleList.clientHeight || 600; const st = subtitleList.scrollTop||0;
      const start = Math.max(0, Math.floor(st / vs.rowH) - BUFFER);
      const end = Math.min(subtitles.length, start + Math.ceil(ch / vs.rowH) + BUFFER*2);
      const topPad = start * vs.rowH; const bottomPad = (subtitles.length - end) * vs.rowH;

      const frag=document.createDocumentFragment();
      const top=document.createElement('div'); top.style.height=topPad+'px'; frag.appendChild(top);

      for(let i=start;i<end;i++){
        const sub=subtitles[i];
        const item=document.createElement('div');
        item.id=`sub-${i}`; item.className='subtitle-item p-2 mb-2 bg-gray-700 rounded-lg text-sm';
        if(reorderMode){ item.setAttribute('draggable','true'); }
        item.addEventListener('click',(e)=>{
          if(reorderMode || batchMode) return;
          if (e.target.tagName!=='INPUT' && !e.target.classList.contains('editable-text') && !e.target.classList.contains('delete-sub-btn') && !e.target.classList.contains('dup-sub-btn') && !e.target.classList.contains('batch-checkbox')){
            videoPlayer.currentTime=sub.startTime; if(videoPlayer.paused) videoPlayer.play();
          }
        });
        if(reorderMode){
          item.addEventListener('dragstart', ()=>{ dragFromIndex=i; item.classList.add('drop-target'); });
          item.addEventListener('dragend', ()=>{ item.classList.remove('drop-target'); });
          item.addEventListener('dragover', (e)=>{ e.preventDefault(); item.classList.add('drop-target'); });
          item.addEventListener('dragleave', ()=>{ item.classList.remove('drop-target'); });
          item.addEventListener('drop', (e)=>{
            e.preventDefault(); item.classList.remove('drop-target');
            const to=i; if(dragFromIndex===-1 || dragFromIndex===to) return;
            try{ pushUndo(); }catch{}
            const moving=subtitles.splice(dragFromIndex,1)[0]; subtitles.splice(to,0,moving);
            dragFromIndex=-1; markDirty(); displaySubtitles();
            const flashRow=document.getElementById(`sub-${to}`); flashRow?.classList.add('flash-highlight'); setTimeout(()=>flashRow?.classList.remove('flash-highlight'), 2200);
          });
        }
        const originalTextHTML=(isComparing && originalSubtitles[i])?`<div class="original-text p-2 whitespace-pre-wrap">${originalSubtitles[i].text}</div>`:'';
        let rightControls = '';
        if(batchMode){ const checked = selectedRows.has(i) ? 'checked' : ''; rightControls = `<input type="checkbox" class="batch-checkbox accent-cyan-500 w-5 h-5" data-index="${i}" ${checked}/>`; }
        else{ rightControls = `<button class="dup-sub-btn icon-btn bg-amber-500 hover:bg-amber-600 text-white text-xs" data-index="${i}" title="Nhân bản dòng">?</button><button class="delete-sub-btn icon-btn bg-transparent text-red-400 hover:text-red-600 font-bold text-xl" data-index="${i}" title="Xóa">&times;</button>`; }
        const dragHandle = `<span class="drag-handle" title="Kéo để sắp xếp">?</span>`;

        const dur = Math.max(0.001, (sub.endTime - sub.startTime)); const text=(sub.text||''); const linesTxt=text.split('\n'); const cpl=Math.max(...linesTxt.map(l=>l.length)); const cps=Math.round(text.replace(/\s/g,'').length/dur); const wpm=Math.round((text.trim().split(/\s+/).filter(Boolean).length)/(dur/60)); const qcClasses=[ (dur<0.8)?'qc-warn-cps':'', (cps>17)?'qc-warn-cps':'', (cpl>42)?'qc-warn-cpl':'', (wpm>160)?'qc-warn-wpm':'' ].filter(Boolean).join(' '); const qcBadge=`<span class="qc-badge">${cps} cps · ${cpl} cpl</span>`;
        item.innerHTML=`<div class="flex items-center justify-between gap-2 mb-1"><div class="flex items-center gap-2 min-w-0">${dragHandle}<span class="subtitle-index-badge">${i+1}</span><input type="text" value="${secondsToTime(sub.startTime)}" data-index="${i}" data-type="start" class="editable-time"><span>--></span><input type="text" value="${secondsToTime(sub.endTime)}" data-index="${i}" data-type="end" class="editable-time"></div><div class="right-tools-wrap">${rightControls}</div></div><div class="text-[11px] text-gray-300 mb-1">${qcBadge}</div>${originalTextHTML}<div contenteditable="true" data-index="${i}" class="editable-text p-2 whitespace-pre-wrap">${sub.text}</div>`;
        frag.appendChild(item);
      }
      const bottom=document.createElement('div'); bottom.style.height=bottomPad+'px'; frag.appendChild(bottom);
      subtitleList.innerHTML=''; subtitleList.appendChild(frag);

      // Attach events for new slice
      subtitleList.querySelectorAll('.editable-time,.editable-text').forEach(el=>{
        el.addEventListener('blur',e=>{
          const idx=+e.target.dataset.index;
          if(e.target.classList.contains('editable-text')){
            const nv = e.target.innerText; if(subtitles[idx].text!==nv){ try{ pushUndo(); }catch{} subtitles[idx].text=nv; markDirty(); }
          }else{
            const type=e.target.dataset.type; try{ const v=timeToSeconds(e.target.value); if(type==='start' && subtitles[idx].startTime!==v){ try{ pushUndo(); }catch{} subtitles[idx].startTime=v; markDirty(); }
            if(type==='end' && subtitles[idx].endTime!==v){ try{ pushUndo(); }catch{} subtitles[idx].endTime=v; markDirty(); } }catch{ e.target.value=secondsToTime(type==='start'?subtitles[idx].startTime:subtitles[idx].endTime); }
          }
        });
        if(el.classList.contains('editable-text')){
          const idx=+el.dataset.index; const updateCaretAndBadge=()=>{ try{ const sel=window.getSelection(); if(sel&&sel.rangeCount>0){ const range=sel.getRangeAt(0); if(el.contains(range.endContainer)){ const pre=range.cloneRange(); pre.selectNodeContents(el); pre.setEnd(range.endContainer, range.endOffset); lastCaretIndex=idx; lastCaretChar=pre.toString().length; } } }catch{} 
            try{ const row=document.getElementById(`sub-${idx}`); if(row){ const text=el.innerText||''; const dur=Math.max(0.001,(subtitles[idx].endTime - subtitles[idx].startTime)); const lines=text.split('\n'); const cpl=Math.max(...lines.map(l=>l.length)); const cps=Math.round(text.replace(/\s/g,'').length/dur); const badge=row.querySelector('.text-[11px]'); if(badge) badge.textContent = `${cps} cps · ${cpl} cpl`; } }catch{} };
          el.addEventListener('keyup', updateCaretAndBadge); el.addEventListener('mouseup', updateCaretAndBadge); el.addEventListener('input', updateCaretAndBadge);
        }
      });
      if(!batchMode){ subtitleList.querySelectorAll('.delete-sub-btn').forEach(btn=>btn.addEventListener('click',(e)=>{ e.stopPropagation(); const idx=+e.target.dataset.index; showConfirmModal(`Xóa dòng phụ đề ${idx+1}?`, ()=>{ try{ pushUndo(); }catch{} subtitles.splice(idx,1); if(isComparing) originalSubtitles.splice(idx,1); markDirty(); displaySubtitles(); applySearchHighlights(); showNotification(`Đã xóa dòng ${idx+1}.`,'success'); }); })); subtitleList.querySelectorAll('.dup-sub-btn').forEach(btn=>btn.addEventListener('click',(e)=>{ e.stopPropagation(); const idx=+e.target.dataset.index; openDuplicateModal(idx); })); } else { subtitleList.querySelectorAll('.batch-checkbox').forEach(cb=>{ cb.addEventListener('change',(e)=>{ const idx=+e.target.dataset.index; if(e.target.checked) selectedRows.add(idx); else selectedRows.delete(idx); updateBatchBtnState(); }); }); }
    }

    /* ===== Display subtitles (supports reorder & batch modes) ===== */
    // Switch to virtualization for very large lists
    function displaySubtitles(){
      if(subtitles && subtitles.length>2000) return displaySubtitlesVirtualized();
      if(!subtitleList) return;
      subtitleList.innerHTML='';
      if(!subtitles.length){
        subtitleList.innerHTML=`<div class="text-gray-500 text-center py-10">Không có dữ liệu phụ đề.</div>`;
        return;
      }
      subtitleList.classList.toggle('reorder-active', reorderMode);

      subtitles.forEach((sub,i)=>{
        const item=document.createElement('div');
        item.id=`sub-${i}`;
        item.className='subtitle-item p-2 mb-2 bg-gray-700 rounded-lg text-sm';
        if(batchMode && selectedRows.has(i)) item.classList.add('selected-row');
        if(reorderMode){ item.setAttribute('draggable','true'); }
        if(batchMode && selectedRows.has(i)) item.classList.add('selected-row');
        item.addEventListener('click',(e)=>{
          if(reorderMode || batchMode) return;
          if (e.target.tagName!=='INPUT' && !e.target.classList.contains('editable-text') && !e.target.classList.contains('delete-sub-btn') && !e.target.classList.contains('dup-sub-btn') && !e.target.classList.contains('batch-checkbox')){
            videoPlayer.currentTime=sub.startTime; if(videoPlayer.paused) videoPlayer.play();
          }
        });

        if(reorderMode){
          item.addEventListener('dragstart', (e)=>{ dragFromIndex=i; item.classList.add('drop-target'); });
          item.addEventListener('dragend', ()=>{ item.classList.remove('drop-target'); });
          item.addEventListener('dragover', (e)=>{ e.preventDefault(); item.classList.add('drop-target'); });
          item.addEventListener('dragleave', ()=>{ item.classList.remove('drop-target'); });
          item.addEventListener('drop', (e)=>{
            e.preventDefault(); item.classList.remove('drop-target');
            const to=i;
            if(dragFromIndex===-1 || dragFromIndex===to) return;
            pushUndo();
            const moving=subtitles.splice(dragFromIndex,1)[0];
            subtitles.splice(to,0,moving);
            dragFromIndex=-1; markDirty(); displaySubtitles();
            const flashRow=document.getElementById(`sub-${to}`);
            flashRow?.classList.add('flash-highlight');
            setTimeout(()=>flashRow?.classList.remove('flash-highlight'), 2200);
          });
        }

        const originalTextHTML=(isComparing && originalSubtitles[i])?`<div class="original-text p-2 whitespace-pre-wrap">${originalSubtitles[i].text}</div>`:'';

        // Right-side controls: batch mode checkbox OR dup/delete
        let rightControls = '';
        if(batchMode){
          const checked = selectedRows.has(i) ? 'checked' : '';
          rightControls = `<input type="checkbox" class="batch-checkbox accent-cyan-500 w-5 h-5" data-index="${i}" ${checked}/>`;
        }else{
          rightControls = `
            <button class="dup-sub-btn icon-btn bg-amber-500 hover:bg-amber-600 text-white text-xs" data-index="${i}" title="Nhân bản dòng">⧉</button>
            <button class="delete-sub-btn icon-btn bg-transparent text-red-400 hover:text-red-600 font-bold text-xl" data-index="${i}" title="Xoá">&times;</button>
          `;
        }

        const dragHandle = `<span class="drag-handle" title="Kéo để sắp xếp">✥</span>`;

        // QC metrics
        const dur = Math.max(0.001, (sub.endTime - sub.startTime));
        const text = (sub.text||'');
        const linesTxt = text.split('\n');
        const cpl = Math.max(...linesTxt.map(l=>l.length));
        const cps = Math.round(text.replace(/\s/g,'').length / dur);
        const wpm = Math.round((text.trim().split(/\s+/).filter(Boolean).length) / (dur/60));
        const qcClasses = [
          (dur < 0.8) ? 'qc-warn-cps' : '',
          (cps > 17) ? 'qc-warn-cps' : '',
          (cpl > 42) ? 'qc-warn-cpl' : '',
          (wpm > 160) ? 'qc-warn-wpm' : ''
        ].filter(Boolean).join(' ');
        const qcBadge = `<span class="qc-badge">${cps} cps · ${cpl} cpl</span>`;
        item.innerHTML=`
          <div class="flex items-center justify-between gap-2 mb-1">
            <div class="flex items-center gap-2 min-w-0">
              ${dragHandle}
              <span class="subtitle-index-badge">${i+1}</span>
              <input type="text" value="${secondsToTime(sub.startTime)}" data-index="${i}" data-type="start" class="editable-time">
              <span>--></span>
              <input type="text" value="${secondsToTime(sub.endTime)}" data-index="${i}" data-type="end" class="editable-time">
            </div>
            <div class="right-tools-wrap">${rightControls}</div>
          </div>
          <div class="text-[11px] text-gray-300 mb-1">${qcBadge}</div>
          ${originalTextHTML}
          <div contenteditable="true" data-index="${i}" class="editable-text p-2 whitespace-pre-wrap">${sub.text}</div>`;

        subtitleList.appendChild(item);
      });

      // events
      document.querySelectorAll('.editable-time,.editable-text').forEach(el=>{
        el.addEventListener('blur',e=>{
          const idx=+e.target.dataset.index;
          if(e.target.classList.contains('editable-text')){
            const nv = e.target.innerText;
            if(subtitles[idx].text!==nv){ try{ pushUndo(); }catch{} subtitles[idx].text=nv; markDirty(); }
          }else{
            const type=e.target.dataset.type;
            try{
              const v=timeToSeconds(e.target.value);
              if(type==='start' && subtitles[idx].startTime!==v){ try{ pushUndo(); }catch{} subtitles[idx].startTime=v; markDirty(); resortSubtitlesByTime(); }
              if(type==='end' && subtitles[idx].endTime!==v){ try{ pushUndo(); }catch{} subtitles[idx].endTime=v; markDirty(); resortSubtitlesByTime(); }
            }catch{
              showNotification('Định dạng thời gian không hợp lệ. Dùng HH:MM:SS,ms','error');
              e.target.value=secondsToTime(type==='start'?subtitles[idx].startTime:subtitles[idx].endTime);
            }
          }
        });
        if(el.classList.contains('editable-text')){
          const idx = +el.dataset.index;
          const updateCaret=()=>{
            try{
              const sel=window.getSelection(); if(!sel||sel.rangeCount===0) return;
              const range=sel.getRangeAt(0); if(!el.contains(range.endContainer)) return;
              const pre=range.cloneRange(); pre.selectNodeContents(el); pre.setEnd(range.endContainer, range.endOffset);
              lastCaretIndex = idx; lastCaretChar = pre.toString().length;
            }catch{}
          };
          el.addEventListener('keyup', updateCaret);
          el.addEventListener('mouseup', updateCaret);
        }
      });

      if(!batchMode){
        document.querySelectorAll('.delete-sub-btn').forEach(btn=>btn.addEventListener('click', (e)=>{
          e.stopPropagation(); const idx=+e.target.dataset.index;
          showConfirmModal(`Xóa dòng phụ đề ${idx+1}?`, ()=>{
            subtitles.splice(idx,1);
            if(isComparing) originalSubtitles.splice(idx,1);
            markDirty(); displaySubtitles(); applySearchHighlights();
            showNotification(`Đã xóa dòng ${idx+1}.`,'success');
          });
        }));
        document.querySelectorAll('.dup-sub-btn').forEach(btn=>btn.addEventListener('click',(e)=>{
          e.stopPropagation(); const idx=+e.target.dataset.index; openDuplicateModal(idx);
        }));
      }else{
        document.querySelectorAll('.batch-checkbox').forEach(cb=>{
          cb.addEventListener('change', (e)=>{
            const idx=+e.target.dataset.index;
            if(e.target.checked) selectedRows.add(idx); else selectedRows.delete(idx);
            updateBatchBtnState();
        });
        if(el.classList.contains('editable-time')){
          el.addEventListener('input', (e)=>{
            try{
              const idx=+e.target.dataset.index; const row=document.getElementById(`sub-${idx}`);
              const text=(subtitles[idx]?.text)||''; const dur=Math.max(0.001,(subtitles[idx].endTime - subtitles[idx].startTime));
              const cpl=Math.max(...text.split('\n').map(l=>l.length)); const cps=Math.round(text.replace(/\s/g,'').length/dur);
              const badge=row?.querySelector('.text-[11px]'); if(badge) badge.textContent = `${cps} cps · ${cpl} cpl`;
            }catch{}
          });
        }
      });
      }

      setTimeout(()=> setSubsHeaderHeightVar(), 0);
    }

    function handleTimeUpdate(){
      if(isNaN(videoPlayer.duration)) return;
      timeline.value=(videoPlayer.currentTime/videoPlayer.duration)*1000;
      timeDisplay.textContent=`${formatTime(videoPlayer.currentTime)} / ${formatTime(videoPlayer.duration)}`;
      let active=-1, txt='';
      for(let i=0;i<subtitles.length;i++){
        if(videoPlayer.currentTime>=subtitles[i].startTime && videoPlayer.currentTime<=subtitles[i].endTime){ active=i; txt=subtitles[i].text; break; }
      }
      subtitleOverlay.innerHTML=txt.replace(/\n/g,'<br>');
      if(active!==currentSubtitleIndex){
        const old=document.getElementById(`sub-${currentSubtitleIndex}`); old&&old.classList.remove('active');
        const now=document.getElementById(`sub-${active}`); 
        if (now){ now.classList.add('active'); scrollToSubtitleIndex(active); }
        currentSubtitleIndex=active;
      }
    }

    function checkDurations(){ if(!isVideoLoaded || !areSubsLoaded || !subtitles.length) return; const vd=videoPlayer.duration, last=subtitles[subtitles.length-1]; if(last && last.endTime>vd+5) showNotification('Cảnh báo: Phụ đề dài hơn video.','warning'); }

    /* ===== A.I. tạo phụ đề ===== */
    env.allowLocalModels=true;
    async function extractAudio(url){ const ctx=new AudioContext({sampleRate:16000}); const r=await fetch(url); const buf=await r.arrayBuffer(); const dec=await ctx.decodeAudioData(buf); return dec.getChannelData(0); }
    async function extractAudioStream(start=0,end=null){
      return new Promise(async (resolve,reject)=>{
        try{
          const duration = videoPlayer.duration||0; const to = end??duration; const from = Math.max(0,start);
          const stream = (videoPlayer.captureStream?.()||videoPlayer.mozCaptureStream?.());
          if(!stream){ return reject(new Error('Trình duyệt không hỗ trợ captureStream.')); }
          if(!stream.getAudioTracks().length) return reject(new Error('Không tìm thấy audio track.'));
          const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':'audio/webm';
          const rec = new MediaRecorder(stream,{mimeType:mime,audioBitsPerSecond:128000});
          const chunks=[]; rec.ondataavailable=(e)=>{ if(e.data && e.data.size) chunks.push(e.data); };
          rec.onstop=async()=>{
            try{ const blob=new Blob(chunks,{type:mime}); const ab=await blob.arrayBuffer(); const ctx=new AudioContext({sampleRate:16000}); const dec=await ctx.decodeAudioData(ab); resolve(dec.getChannelData(0)); }catch(e){ reject(e); }
          };
          const prevMuted = videoPlayer.muted, prevRate=videoPlayer.playbackRate; videoPlayer.muted=true; videoPlayer.playbackRate=1.0; videoPlayer.currentTime=from; rec.start(250);
          const onTime=()=>{ if(videoPlayer.currentTime>=to){ rec.stop(); videoPlayer.pause(); videoPlayer.removeEventListener('timeupdate', onTime); videoPlayer.muted=prevMuted; videoPlayer.playbackRate=prevRate; } };
          videoPlayer.addEventListener('timeupdate', onTime);
          if(videoPlayer.paused) await videoPlayer.play();
        }catch(e){ reject(e); }
      });
    }
    let aiTimer;
    function startIndeterminate(statusText){
      aiProgressContainer?.classList.remove('hidden');
      if(aiStatus) aiStatus.textContent=statusText||'Đang xử lý…';
      clearInterval(aiTimer);
      aiTimer = setInterval(()=>{ if(aiStatus){ aiStatus.textContent = aiStatus.textContent.endsWith('……') ? statusText : aiStatus.textContent + '…'; } }, 500);
    }
    function stopIndeterminate(){ clearInterval(aiTimer); aiProgressContainer?.classList.add('hidden'); }
    function normalizeWhisperLang(code){
      if(!code) return undefined;
      if(code==='auto') return undefined;
      if(code==='zh-CN'||code==='zh-TW') return 'zh';
      if(code==='iw') return 'he';
      if(code==='jw') return 'jv';
      return code.split('-')[0];
    }
    function updateModelStatus(){ const name=currentModel?currentModel.replace('Xenova/',''): 'Chưa tải'; aiModelStatus && (aiModelStatus.textContent=`Trạng thái model: ${name}`); }

    async function generateSubtitlesFromVideo(){
      if(!videoPlayer.src) return showNotification('Vui lòng chọn video trước.','warning');
      const selectedModel=aiModelSelect.value; const modelFullName=`Xenova/whisper-${selectedModel}`;
      const selectedLangRaw=aiLangSelect.value; const selectedLang = normalizeWhisperLang(selectedLangRaw);
      generateSubsBtn.disabled=true;
      try{
        if(!transcriber || currentModel!==modelFullName){
          startIndeterminate('Đang tải model A.I');
          transcriber=await pipeline('automatic-speech-recognition', modelFullName, { progress_callback:(p)=>{ if(aiStatus && p && p.progress){ const pct=Math.round(p.progress*100); const mb=((p.loaded||0)/1048576).toFixed(1); const tmb=((p.total||0)/1048576).toFixed(1); aiStatus.textContent=`Tải ${p.file||''}: ${pct}% (${mb}/${tmb} MB)`; } } });
          currentModel=modelFullName; loadedModels.add(modelFullName); updateModelStatus(); stopIndeterminate();
        }
        startIndeterminate('Đang xử lý âm thanh');
        const audio=await extractAudio(videoPlayer.src);
        stopIndeterminate();
        startIndeterminate('A.I. đang nhận dạng giọng nói');
        const opts = { chunk_length_s:30, stride_length_s:5, task:'transcribe', return_timestamps:true, callback_function:()=>{} };
        if(selectedLang) opts.language = selectedLang;
        const out=await transcriber(audio, opts);
        stopIndeterminate();
        startIndeterminate('Đang định dạng phụ đề');
        if(out && Array.isArray(out.chunks)){
          subtitles=out.chunks.map(c=>({startTime:c.timestamp[0], endTime:c.timestamp[1], text:c.text.trim()}));
        }else if(out && out.text){
          subtitles=[{ startTime:0, endTime:videoPlayer.duration||5, text:out.text.trim() }];
          showNotification('A.I. không tạo được mốc thời gian chi tiết.','warning');
        }else throw new Error('Đầu ra A.I. không hợp lệ.');
        originalSubtitles=JSON.parse(JSON.stringify(subtitles));
        displaySubtitles();
        const langName=(LANGUAGES[selectedLangRaw]||selectedLangRaw||'Đã chọn');
        updateSubLangDisplay(`${langName} (A.I. tạo)`, selectedLangRaw||'unk');
        markDirty();
        showNotification('Tạo phụ đề A.I. thành công.','success');
      }catch(err){ console.error(err); showNotification('A.I. gặp lỗi: '+err.message,'error'); }
      finally{ stopIndeterminate(); generateSubsBtn.disabled=false; }
    }

    /* ===== Build context + prompts ===== */
    function parseGlossary(text){
      const dict={};
      text.split('\n').map(l=>l.trim()).filter(Boolean).forEach(line=>{
        const eq=line.indexOf('=');
        if(eq>0){ const k=line.slice(0,eq).trim(); const v=line.slice(eq+1).trim(); if(k&&v) dict[k]=v; }
      });
      return dict;
    }
    function buildContextBlock(){
      return subtitles.map((s,i)=>`${i+1}. [${secondsToTime(s.startTime)} --> ${secondsToTime(s.endTime)}] ${s.text}`).join('\n');
    }
    function buildPromptSystem(source, target){
      const style = document.getElementById('opt-style')?.value || 'neutral';
      const literal = document.getElementById('opt-literalness')?.value || 'balanced';
      const keepSlang = document.getElementById('opt-slang')?.checked || false;
      const glossary = parseGlossary(document.getElementById('opt-glossary')?.value||'');

      const sLabel = (source==='auto')?'auto-detect language':(LANGUAGES[source]||source);
      const tLabel = LANGUAGES[target]||target;

      const styleMap = { neutral:'neutral tone', formal:'formal tone', casual:'casual natural tone', creative:'creative and natural tone without losing meaning' };
      const litMap = { balanced:'balanced between literal and natural', literal:'more literal and faithful to the source', free:'freer and idiomatic but accurate' };
      const glossStr = Object.keys(glossary).length
        ? 'Use these terminology pairs strictly: ' + Object.entries(glossary).map(([k,v])=>`${k}=${v}`).join(', ') + '.'
        : 'Preserve proper names/terms consistently.';

      return `You are a world-class literary subtitle translator.
- Source language: ${sLabel}
- Target language: ${tLabel}
- Style: ${styleMap[style]}
- Faithfulness: ${litMap[literal]}
- ${keepSlang?'Keep slang/colloquial flavor when appropriate.':'Avoid adding slang if not present.'}
- ${glossStr}
Rules:
- Output ONLY the translation, no quotes, no explanations.
- Preserve original line breaks.
- Make punctuation natural for ${tLabel}.`;
    }

    const CUSTOM_PROMPT_STORAGE_KEY = 'customPromptTemplate_v1';
    let useCustomPrompt = false;
    let customPromptTemplate = localStorage.getItem(CUSTOM_PROMPT_STORAGE_KEY) || '';

    function compilePrompt(template, context, line){
      return template
        .replaceAll('{{CONTEXT}}', context || '')
        .replaceAll('{{LINE}}', line || '');
    }

    function openPromptModal(){
      const source=sourceLanguageSelect.value, target=targetLanguageSelect.value;
      const ctxEnabled = document.getElementById('opt-context')?.checked;
      const contextBlock = ctxEnabled ? buildContextBlock() : '';
      const sys = buildPromptSystem(source, target);

      const defaultTemplate = `SYSTEM:
${sys}

USER:
${ctxEnabled ? 'Context (full subtitles):\n{{CONTEXT}}\n\n' : ''}Translate the following subtitle line with full coherence. Output only the translation:
{{LINE}}`;

      const currentTemplate = customPromptTemplate || defaultTemplate;

      showModal(
        `<div class="modal-content space-y-3">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-bold text-cyan-400 flex items-center gap-2"><svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 12.5 8 15l2 2.5"/><path d="m14 12.5 2 2.5-2 2.5"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"/></svg><span>Prompt nâng cao</span></h3>
            <button class="close-modal-btn font-bold text-2xl">&times;</button>
          </div>
          <div class="text-xs text-gray-300">Bạn có thể dùng biến <code>{{CONTEXT}}</code> (toàn bộ phụ đề) và <code>{{LINE}}</code> (dòng đang dịch).</div>
          <textarea id="custom-prompt-ta" rows="16" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm">${currentTemplate.replace(/</g,'&lt;')}</textarea>
          <div class="flex items-center justify-between">
            <label class="inline-flex items-center gap-2">
              <input id="use-custom-prompt-chk" type="checkbox" class="accent-cyan-500" ${useCustomPrompt?'checked':''}/>
              <span>Dùng prompt tùy chỉnh</span>
            </label>
            <div class="flex gap-2">
              <button class="cancel-btn bg-gray-600 hover:bg-gray-500 text-white px-3 py-2 rounded">Đóng</button>
              <button id="save-prompt-btn" class="bg-sky-600 hover:bg-sky-500 text-white px-3 py-2 rounded">Lưu</button>
            </div>
          </div>
        </div>`,
        (m)=>{
          m.querySelector('#save-prompt-btn').onclick=()=>{
            const val = m.querySelector('#custom-prompt-ta').value;
            customPromptTemplate = val;
            localStorage.setItem(CUSTOM_PROMPT_STORAGE_KEY, customPromptTemplate);
            useCustomPrompt = m.querySelector('#use-custom-prompt-chk').checked;
            const useChk = document.getElementById('opt-use-custom-prompt');
            if(useChk) useChk.checked = useCustomPrompt;
            showNotification('Đã lưu prompt tùy chỉnh.','success');
            m.remove();
          };
          m.querySelector('#use-custom-prompt-chk').onchange=(e)=>{
            useCustomPrompt = e.target.checked;
            const useChk = document.getElementById('opt-use-custom-prompt');
            if(useChk) useChk.checked = useCustomPrompt;
          };
        }
      );
    }

    /* ===== Translate ===== */
    function handleServiceChange(){
      const svc=translationServiceSelect.value;
      const need=['OpenAI','DeepL','Gemini'].includes(svc);
      apiKeyContainer?.classList.toggle('hidden', !need);
      if(need){ apiKeyLabel.textContent=`${svc} API Key`; loadApiKeyForService(svc); }
      // Advanced options visibility
      const adv=document.getElementById('adv-opts-container');
      const promptBtn=document.getElementById('prompt-advanced-btn');
      if(adv) adv.classList.toggle('hidden', !(svc==='OpenAI'||svc==='Gemini'));
      if(promptBtn) promptBtn.classList.toggle('hidden', !(svc==='OpenAI'||svc==='Gemini'));

      // MyMemory không hỗ trợ source=auto => disable
      const autoOpt = [...sourceLanguageSelect.options].find(o=>o.value==='auto');
      if(svc==='MyMemory'){
        if(autoOpt) autoOpt.disabled = true;
        if(sourceLanguageSelect.value==='auto'){
          showNotification('MyMemory không hỗ trợ “Tự động phát hiện” cho NGUỒN. Vui lòng chọn ngôn ngữ nguồn.','warning',7000);
        }
      }else{
        if(autoOpt) autoOpt.disabled = false;
      }
    }

    function buildUserPromptForLine(source, target, lineText, contextText){
      const sys = buildPromptSystem(source, target);
      if(useCustomPrompt && customPromptTemplate){
        return compilePrompt(customPromptTemplate, contextText, lineText);
      }
      return `SYSTEM:
${sys}

USER:
${contextText ? `Context (full subtitles):\n${contextText}\n\n` : ''}Translate the following subtitle line with coherence. Output only the translation:
${lineText}`;
    }

    async function translateSubtitles(){
      if(!subtitles.length) return showNotification('Vui lòng mở sub trước.','warning');
      const source=sourceLanguageSelect.value, target=targetLanguageSelect.value, svc=translationServiceSelect.value;
      if(!source||!target) return showNotification('Vui lòng chọn ngôn ngữ nguồn và đích.','warning');
      if(source===target && source!=='auto') return showNotification('Ngôn ngữ nguồn và đích không được giống nhau.','warning');

      loadingSpinner?.classList.remove('hidden'); translateBtn.disabled=true; originalSubtitles=JSON.parse(JSON.stringify(subtitles));
      if(translateProgress) translateProgress.textContent = '';

      try{
        const ctxEnabled = document.getElementById('opt-context')?.checked;
        const contextBlock = (svc==='OpenAI' || svc==='Gemini') && ctxEnabled ? buildContextBlock() : '';

        const map={ Google:translateWithGoogle, LibreTranslate:translateWithLibreTranslate, MyMemory:translateWithMyMemory, DeepL:translateWithDeepL, OpenAI:translateWithOpenAI, Gemini:translateWithGemini };
        const fn=map[svc]; if(!fn) throw new Error('Dịch vụ không hợp lệ.');
        saveApiKeyForCurrentService();

        let ok=0, fail=0;
        for(let i=0;i<subtitles.length;i++){
          if(translateProgress) translateProgress.textContent = `Đang dịch ${i+1}/${subtitles.length}…`;
          const res = await fn(subtitles[i].text, source, target, contextBlock);
          if(res && res.success){ subtitles[i].text = res.text; ok++; }
          else { fail++; }
        }
        displaySubtitles();
        if(ok>0){ updateSubLangDisplay(LANGUAGES[target]||target, target); markDirty(); }
        if(ok===0){ showNotification('Không thể dịch phụ đề với dịch vụ đã chọn. Kiểm tra cấu hình/khóa API.','error',9000); }
        else if(fail>0){ showNotification(`Đã xử lý dịch. Thành công: ${ok}, lỗi: ${fail}.`, 'warning', 9000); }
        else showNotification(`Đã dịch xong ${ok} dòng.`, 'success');
        subPanelCompareSwitchContainer?.classList.remove('hidden');
      }catch(err){ console.error(err); showNotification('Không thể thực hiện dịch: '+err.message,'error',9000); }
      finally{ loadingSpinner?.classList.add('hidden'); translateBtn.disabled=false; if(translateProgress) translateProgress.textContent=''; }
    }

    async function translateWithMyMemory(text, source, target){
      try{
        if(source==='auto') return {success:false, error:'MyMemory không hỗ trợ nguồn = auto'};
        const url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${source}|${target}`;
        const r=await fetch(url);
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const d=await r.json();
        if(d.responseStatus!==200){
          if(d.responseDetails?.includes('VISIT')) throw new Error('Đã hết quota MyMemory miễn phí.');
          throw new Error(d.responseDetails||'MyMemory lỗi.');
        }
        return {success:true, text:d.responseData.translatedText};
      }catch(e){ return {success:false, error:'MyMemory: '+e.message}; }
    }
    async function translateWithGoogle(text, source, target){
      try{
        const url=`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${source}&tl=${target}&dt=t&q=${encodeURIComponent(text)}`;
        const r=await fetch(url);
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const d=await r.json();
        const out=(d[0]||[]).map(i=>i[0]).join('');
        return {success:true, text:out};
      }catch(e){ return {success:false, error:'Google Translate: '+e.message}; }
    }
    async function translateWithLibreTranslate(text, source, target){
      const body = JSON.stringify({ q:text, source, target, format:'text' });
      async function attempt(endpoint){
        const r=await fetch(endpoint,{ method:'POST', headers:{'Content-Type':'application/json'}, body });
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const d=await r.json();
        if(d.error) throw new Error(d.error);
        return d.translatedText;
      }
      try{
        try{ 
          const t=await attempt('https://libretranslate.de/translate');
          return {success:true, text:t};
        }catch(_){
          const t2=await attempt('https://libretranslate.com/translate');
          return {success:true, text:t2};
        }
      }catch(e){ return {success:false, error:'LibreTranslate: '+e.message}; }
    }
    async function translateWithDeepL(text, source, target){
      const inp=document.getElementById('api-key-input'); const key=inp?inp.value:'';
      if(!key) return {success:false, error:'Thiếu API Key DeepL.'};
      const free=key.endsWith(':fx');
      const url=free?'https://api-free.deepl.com/v2/translate':'https://api.deepl.com/v2/translate';
      try{
        const r=await fetch(url,{ method:'POST', headers:{'Authorization':`DeepL-Auth-Key ${key}`,'Content-Type':'application/json'}, body:JSON.stringify({ text:[text], target_lang:target.toUpperCase().split('-')[0] })});
        if(!r.ok){ let err=`HTTP ${r.status}`; try{ const ed=await r.json(); err=ed.message||err; }catch{} throw new Error(err); }
        const d=await r.json();
        return {success:true, text:d.translations[0].text};
      }catch(e){ return {success:false, error:'DeepL: '+e.message}; }
    }
    async function translateWithOpenAI(text, source, target, contextText){
      const inp=document.getElementById('api-key-input'); const key=inp?inp.value:'';
      if(!key) return {success:false, error:'Thiếu API Key OpenAI.'};
      const prompt = buildUserPromptForLine(source, target, text, contextText);
      try{
        const r=await fetch('https://api.openai.com/v1/chat/completions',{
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},
          body:JSON.stringify({ model:'gpt-4o-mini', temperature:0.2, messages:[{role:'user',content:prompt}] })
        });
        const d=await r.json();
        if(!r.ok){ const err=d?.error?.message||`HTTP ${r.status}`; throw new Error(err); }
        const out=d?.choices?.[0]?.message?.content?.trim();
        if(!out) throw new Error('Phản hồi rỗng.');
        return {success:true, text:out};
      }catch(e){ return {success:false, error:'OpenAI: '+e.message}; }
    }
    async function translateWithGemini(text, source, target, contextText){
      const inp=document.getElementById('api-key-input'); const key=inp?inp.value:'';
      if(!key) return {success:false, error:'Thiếu API Key Gemini.'};
      const MODEL='gemini-1.5-flash';
      const url=`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`;
      const prompt = buildUserPromptForLine(source, target, text, contextText);
      try{
        const r=await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ contents:[{ role:'user', parts:[{ text: prompt }]}], generationConfig:{ temperature:0.2 } })});
        if(!r.ok){ let err=`HTTP ${r.status}`; try{ const ed=await r.json(); err=ed?.error?.message||err; }catch{} throw new Error(err); }
        const d=await r.json();
        const out=d?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
        if(!out){ const fr=d?.candidates?.[0]?.finishReason; if(fr==='SAFETY') return {success:false, error:'Gemini từ chối do kiểm duyệt nội dung.'}; return {success:false, error:'Gemini trả về rỗng/không hợp lệ.'}; }
        return {success:true, text:out};
      }catch(e){ return {success:false, error:'Gemini: '+e.message}; }
    }

    /* ===== Tools overlay (desktop only) ===== */
    let toolsScrollPos = 0;
    function expandTools(exp){
      if(window.innerWidth<1024) return;
      if(!toolsPanel) return;
      if(exp){
        toolsPanel.classList.add('expanded');
        if(toolsContentWrapper) toolsContentWrapper.scrollTop = toolsScrollPos;
        if(toggleIcon) toggleIcon.style.transform='rotate(180deg)';
      }else{
        if(toolsContentWrapper) toolsScrollPos = toolsContentWrapper.scrollTop;
        toolsPanel.classList.remove('expanded');
        if(toggleIcon) toggleIcon.style.transform='rotate(0deg)';
      }
    }
    window.addEventListener('resize', setSubsHeaderHeightVar);
    setSubsHeaderHeightVar();

    /* ===== Events & wiring ===== */
    function handleVideoFile(file){
      if(file && file.type.startsWith('video/')){
        videoFile=file;
        videoPlayer.src=URL.createObjectURL(videoFile);
        videoPlaceholderContainer.style.display='none';
        videoPlayer.style.display='block';
        videoPlayer.load();
        isVideoLoaded=false;
      } else showNotification('Vui lòng chọn một file video hợp lệ.','error');
    }
    videoInput.addEventListener('change',(e)=>handleVideoFile(e.target.files[0]));

    videoPlayer.addEventListener('click', togglePlayPause);
    playPauseBtn.addEventListener('click', togglePlayPause);
    stopBtn.addEventListener('click', ()=>{ videoPlayer.pause(); videoPlayer.currentTime=0; });

    infoBtn.addEventListener('click', showVideoInfo);
    timeline.addEventListener('input', ()=>{ if(videoPlayer.duration) videoPlayer.currentTime=(timeline.value/1000)*videoPlayer.duration; });
    volumeSlider.addEventListener('input', ()=> videoPlayer.volume = volumeSlider.value);
    videoPlayer.addEventListener('volumechange', syncMuteIcon);
    muteBtn.addEventListener('click', ()=>{
      videoPlayer.muted = !videoPlayer.muted;
      syncMuteIcon();
    });

    fullscreenBtn.addEventListener('click', customFullscreenToggle);

    syncPlayPauseIcon();
    syncMuteIcon();

    videoPlayer.addEventListener('play', syncPlayPauseIcon);
    videoPlayer.addEventListener('pause', syncPlayPauseIcon);
    videoPlayer.addEventListener('timeupdate', handleTimeUpdate);
    videoPlayer.addEventListener('loadedmetadata', ()=>{
      isVideoLoaded=true; handleTimeUpdate(); checkDurations();
      if(videoFile) showNotification(`Đã tải thành công video: ${videoFile.name}`,'success');
    });

    videoPlaceholder.addEventListener('click', ()=> videoInput.click());
    ;['dragenter','dragover','dragleave','drop'].forEach(ev=> videoWrapper.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); }, false));
    ;['dragenter','dragover'].forEach(ev=> videoWrapper.addEventListener(ev, ()=> dragOverlay.classList.remove('hidden'), false));
    ;['dragleave','drop'].forEach(ev=> videoWrapper.addEventListener(ev, ()=> dragOverlay.classList.add('hidden'), false));
    videoWrapper.addEventListener('drop', (e)=> handleVideoFile(e.dataTransfer.files[0]), false);

    saveSrtBtn.addEventListener('click', saveSRTFile);
    subtitleInput.addEventListener('change', handleSubtitleInput);

    // Mobile tabs
    tabSubs?.addEventListener('click', ()=>{
      subtitlePanel?.classList.remove('hidden');
      toolsPanel?.classList.add('hidden');
      tabSubs.classList.add('active'); tabSubs.classList.remove('bg-gray-700','text-gray-300');
      tabTools.classList.remove('active'); tabTools.classList.add('bg-gray-700','text-gray-300');
      expandTools(false);
    });
    tabTools?.addEventListener('click', ()=>{
      subtitlePanel?.classList.add('hidden');
      toolsPanel?.classList.remove('hidden');
      toolsContentWrapper?.classList.remove('hidden');
      tabTools.classList.add('active'); tabTools.classList.remove('bg-gray-700','text-gray-300');
      tabSubs.classList.remove('active'); tabSubs.classList.add('bg-gray-700','text-gray-300');
    });

    // Desktop overlay header click toggles
    toolsHeader?.addEventListener('click', ()=>{ if(window.innerWidth>=1024){ const expanded=toolsPanel?.classList.contains('expanded'); expandTools(!expanded); } });
    // Click subtitle header/panel while tools expanded -> collapse
    subtitleHeader?.addEventListener('click', ()=>{ if(window.innerWidth>=1024 && toolsPanel?.classList.contains('expanded')) expandTools(false); });
    subtitlePanel?.addEventListener('click', (e)=>{ 
      if(window.innerWidth>=1024 && toolsPanel?.classList.contains('expanded')){
        const inHeader = e.target.closest('#subtitle-header-wrap');
        if(!inHeader) expandTools(false);
      }
    });

    generateSubsBtn.addEventListener('click', generateSubtitlesFromVideo);

    // Populate AI languages (NO auto)
    function populateAiLangSelect(){
      aiLangSelect.innerHTML='';
      Object.entries(LANGUAGES).forEach(([code])=>{
        if(code==='auto') return;
        const opt=document.createElement('option');
        opt.value = code;
        const display = getLanguageDisplay(code);
        opt.textContent = display.text;
        opt.dataset.label = display.label.toLowerCase();
        aiLangSelect.appendChild(opt);
      });
      ensureSelectHasValue(aiLangSelect, preferredUILanguage);
    }
    populateAiLangSelect();
    aiLangSearch.addEventListener('input', ()=>{
      const q=aiLangSearch.value.toLowerCase();
      [...aiLangSelect.options].forEach(o=>{
        if(!o.value) return;
        const label=(o.dataset.label||o.textContent||'').toLowerCase();
        o.hidden = !(label.includes(q) || o.value.toLowerCase().includes(q));
      });
    });

    // Populate source/target language selects
    function populateLanguageSelects(){
      const fill=(sel, includeAuto)=>{
        sel.innerHTML='';
        if(includeAuto){
          const autoDisplay=getLanguageDisplay('auto');
          const o=document.createElement('option');
          o.value='auto';
          o.textContent=autoDisplay.text;
          o.dataset.label=autoDisplay.label.toLowerCase();
          sel.appendChild(o);
        }
        Object.entries(LANGUAGES).forEach(([code])=>{
          if(code==='auto') return;
          const opt=document.createElement('option');
          opt.value=code;
          const display=getLanguageDisplay(code);
          opt.textContent=display.text;
          opt.dataset.label=display.label.toLowerCase();
          sel.appendChild(opt);
        });
      };
      fill(sourceLanguageSelect, true);
      fill(targetLanguageSelect, false);
      sourceLanguageSelect.value='auto';
      ensureSelectHasValue(targetLanguageSelect, preferredUILanguage);
    }
    populateLanguageSelects();

    sourceLangSearch.addEventListener('input', (e)=>{
      const q=e.target.value.toLowerCase();
      [...sourceLanguageSelect.options].forEach(o=>{
        const label=(o.dataset.label||o.textContent||'').toLowerCase();
        o.hidden = !(label.includes(q) || o.value.toLowerCase().includes(q));
      });
    });
    targetLangSearch.addEventListener('input', (e)=>{
      const q=e.target.value.toLowerCase();
      [...targetLanguageSelect.options].forEach(o=>{
        const label=(o.dataset.label||o.textContent||'').toLowerCase();
        o.hidden = !(label.includes(q) || o.value.toLowerCase().includes(q));
      });
    });


    updateUiLanguageSelectOptions();
    syncUiLanguageSelectors();
    uiLanguageSelectors.forEach(sel=>{
      if(!sel) return;
      sel.addEventListener('change', (e)=> setPreferredLanguage(e.target.value));
    });
    setPreferredLanguage(preferredUILanguage, { skipPersist: true });
    if(!hasStoredLanguage){
      setTimeout(()=> showUiLanguageModal(), 200);
    }

    translateBtn.addEventListener('click', translateSubtitles);
    translationServiceSelect.addEventListener('change', handleServiceChange);
    handleServiceChange();

    // API key visibility
    toggleApiVisibilityBtn.addEventListener('click', ()=>{
      apiKeyInput.type = apiKeyInput.type === 'password' ? 'text' : 'password';
    });

    // Compare switch (only one visible variant here)
    function setCompareUI(on){
      const btn=subPanelCompareSwitch; if(!btn) return;
      const labelOn = 'Tắt so sánh phụ đề';
      const labelOff = 'Bật chế độ so sánh phụ đề';
      btn.classList.toggle('switch-on', on);
      btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      btn.setAttribute('aria-label', on ? labelOn : labelOff);
      const sr = btn.querySelector('.sr-only');
      if(sr) sr.textContent = on ? labelOn : labelOff;
      const knob = btn.querySelector('.switch-knob');
      if(knob) knob.style.transform = on ? 'translateX(1.25rem)' : 'translateX(0)';
    }
    function toggleCompareMode(){
      isComparing = !isComparing;
      setCompareUI(isComparing);
      displaySubtitles();
    }
    subPanelCompareSwitch?.addEventListener('click', toggleCompareMode);
    setCompareUI(isComparing);

    // Add new subtitle line
    function addNewSubtitleLine(){
      const lastSub=subtitles[subtitles.length-1];
      const startTime= lastSub ? (lastSub.endTime + 0.1) : (videoPlayer.currentTime || 0);
      const newSub={ startTime, endTime:startTime+3, text:'Dòng phụ đề mới...' };
      subtitles.push(newSub);
      if(isComparing) originalSubtitles.push(JSON.parse(JSON.stringify(newSub)));
      displaySubtitles();
      const newIndex=subtitles.length-1;
      scrollToSubtitleIndex(newIndex);
      markDirty();
    }
    addSubLineBtn.addEventListener('click', addNewSubtitleLine);

    // Xếp (reorder)
    function setReorderUI(on){
      reorderMode = on;
      subtitleList?.classList.toggle('reorder-active', on);
      reorderToggle?.classList.toggle('unsaved-glow', on);
      displaySubtitles();
    }
    reorderToggle.addEventListener('click', ()=>{
      resortSubtitlesByTime();
      setReorderUI(!reorderMode);
    });

    // Prompt advanced button
    const promptAdvancedBtn = document.getElementById('prompt-advanced-btn');
    const useCustomPromptChk = document.getElementById('opt-use-custom-prompt');
    if(useCustomPromptChk) useCustomPromptChk.checked = useCustomPrompt;
    promptAdvancedBtn?.addEventListener('click', openPromptModal);
    useCustomPromptChk?.addEventListener('change', (e)=>{ useCustomPrompt = e.target.checked; });

    // Subtitle search
    function computeSearchHits(q){
      searchHits = [];
      if(!q) return;
      const lower = q.toLowerCase();
      subtitles.forEach((s, i)=>{
        if(s.text.toLowerCase().includes(lower)) searchHits.push(i);
      });
    }
    function applySearchHighlights(){
      document.querySelectorAll('.subtitle-item').forEach(el=>{ el.classList.remove('search-hit','current-hit'); });
      searchHits.forEach((idx, k)=>{
        const el=document.getElementById(`sub-${idx}`);
        if(el){ el.classList.add('search-hit'); if(k===currentHitIdx) el.classList.add('current-hit'); }
      });
    }
    function gotoHit(dir){
      if(!searchHits.length) return;
      currentHitIdx = (currentHitIdx + (dir||0) + searchHits.length) % searchHits.length;
      const idx = searchHits[currentHitIdx];
      scrollToSubtitleIndex(idx);
      applySearchHighlights();
    }
    subtitleSearchInput.addEventListener('input', ()=>{
      computeSearchHits(subtitleSearchInput.value.trim());
      currentHitIdx = -1;
      gotoHit(+1);
      applySearchHighlights();
    });
    subtitleSearchPrevBtn.addEventListener('click', ()=> gotoHit(-1));
    subtitleSearchNextBtn.addEventListener('click', ()=> gotoHit(+1));
    subtitleSearchClearBtn.addEventListener('click', ()=>{
      subtitleSearchInput.value=''; searchHits=[]; currentHitIdx=-1; applySearchHighlights();
    });

    // Duplicate line modal
    function openDuplicateModal(index){
      const modalHtml = `
        <div class="modal-content space-y-3">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-bold text-cyan-400 flex items-center gap-2"><svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg><span>Nhân bản dòng #${index+1}</span></h3>
            <button class="close-modal-btn font-bold text-2xl">&times;</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-medium" for="dup-pos">Vị trí</label>
              <select id="dup-pos" class="w-full bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm">
                <option value="below" selected>Phía dưới</option>
                <option value="above">Phía trên</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-medium" for="dup-align">Canh chỉnh thời gian</label>
              <select id="dup-align" class="w-full bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm">
                <option value="none" selected>Không canh chỉnh</option>
                <option value="adjacent">Liền kề</option>
                <option value="all">Tất cả</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-medium" for="dup-dur">Thời lượng (giây) cho dòng mới</label>
              <input id="dup-dur" type="number" min="0.1" step="0.1" value="3" class="w-full bg-gray-900 border border-gray-500 rounded px-2 py-1 text-sm"/>
            </div>
            <div>
              <label class="text-xs font-medium" for="dup-push">Đẩy thời gian các dòng khác (giây)</label>
              <input id="dup-push" type="number" min="0" step="0.1" value="0" class="w-full bg-gray-900 border border-gray-500 rounded px-2 py-1 text-sm"/>
            </div>
          </div>
          <div class="flex justify-end gap-2 pt-2">
            <button class="cancel-btn bg-gray-600 hover:bg-gray-500 text-white px-3 py-2 rounded">Hủy</button>
            <button id="dup-confirm" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-2 rounded">Nhân bản</button>
          </div>
        </div>`;
      showModal(modalHtml, (m)=>{
        m.querySelector('#dup-confirm').onclick = ()=>{
          const pos = m.querySelector('#dup-pos').value;
          const align = m.querySelector('#dup-align').value;
          const dur = Math.max(0.1, parseFloat(m.querySelector('#dup-dur').value||'3'));
          const push = Math.max(0, parseFloat(m.querySelector('#dup-push').value||'0'));
          const src = subtitles[index];
          const newSub = { startTime: src.startTime, endTime: src.startTime+dur, text: src.text };
          const insertAt = pos==='below' ? index+1 : index;
          subtitles.splice(insertAt, 0, newSub);
          if(align==='adjacent'){
            if(pos==='below'){ newSub.startTime = src.endTime; newSub.endTime = newSub.startTime + dur; }
            else{ newSub.endTime = src.startTime; newSub.startTime = newSub.endTime - dur; if(newSub.startTime<0) newSub.startTime=0; }
          }else if(align==='all'){
            const delta = (pos==='below') ? dur+push : -(dur+push);
            for(let i=(pos==='below'?(insertAt+1):0); i<subtitles.length; i++){
              if(i===insertAt) continue;
              subtitles[i].startTime += delta;
              subtitles[i].endTime += delta;
            }
          }
          markDirty(); displaySubtitles(); scrollToSubtitleIndex(insertAt);
          const row=document.getElementById(`sub-${insertAt}`); row?.classList.add('flash-highlight'); setTimeout(()=>row?.classList.remove('flash-highlight'),2200);
          m.remove();
        };
      });
    }

    /* ===== Subtitle appearance controls ===== */
    subTextColorInput?.addEventListener('input', (e)=> document.documentElement.style.setProperty('--sub-text-color', e.target.value));
    subBgColorInput?.addEventListener('input', (e)=> document.documentElement.style.setProperty('--sub-bg-color', hexToRgba(e.target.value, 0.5)));
    subFontSizeInput?.addEventListener('input', (e)=>{ const v=e.target.value; if(fontSizeLabel) fontSizeLabel.textContent=v; document.documentElement.style.setProperty('--sub-font-size', v+'px'); });
    subBottomPosInput?.addEventListener('input', (e)=>{ const v=e.target.value; if(bottomPosLabel) bottomPosLabel.textContent=v; document.documentElement.style.setProperty('--sub-bottom-pos', v+'px'); });

    /* ===== Batch edit ===== */
    function updateBatchBtnState(){
      if(!batchMode){ batchBtn.textContent = 'Chỉnh hàng loạt'; return; }
      batchBtn.textContent = selectedRows.size>0 ? 'Áp dụng hàng loạt' : 'Chỉnh hàng loạt';
    }
    function toggleBatchMode(on){
      batchMode = (on===undefined)? !batchMode : !!on;
      batchSelectAllWrap?.classList.toggle('hidden', !batchMode);
      if(!batchMode){ selectedRows.clear(); if(batchSelectAll) batchSelectAll.checked=false; }
      updateBatchBtnState();
      displaySubtitles();
    }
    batchBtn.addEventListener('click', ()=>{
      if(!batchMode){
        toggleBatchMode(true);
      }else{
        if(selectedRows.size===0){ toggleBatchMode(false); return; }
        const modalHtml = `
          <div class="modal-content space-y-3">
            <div class="flex justify-between items-center">
              <h3 class="text-lg font-bold text-cyan-400 flex items-center gap-2"><svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 5h8"/><path d="M13 12h8"/><path d="M13 19h8"/><path d="m3 17 2 2 4-4"/><path d="m3 7 2 2 4-4"/></svg><span>Áp dụng hàng loạt (${selectedRows.size} dòng)</span></h3>
              <button class="close-modal-btn font-bold text-2xl">&times;</button>
            </div>
            <div class="space-y-3">
              <label class="inline-flex items-center gap-2"><input id="ba-del" type="checkbox" class="accent-rose-500"/><span>Xóa các phụ đề đã chọn</span></label>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="bg-gray-700/40 p-3 rounded">
                  <label class="inline-flex items-center gap-2 mb-2"><input id="ba-start" type="checkbox" class="accent-cyan-500"/><span>Điều chỉnh thời gian <strong>bắt đầu</strong></span></label>
                  <div class="flex items-center gap-2">
                    <span class="text-sm">Δ (giây):</span>
                    <input id="ba-start-delta" type="number" step="0.1" value="0" class="w-28 bg-gray-900 border border-gray-500 rounded px-2 py-1 text-sm"/>
                  </div>
                </div>
                <div class="bg-gray-700/40 p-3 rounded">
                  <label class="inline-flex items-center gap-2 mb-2"><input id="ba-end" type="checkbox" class="accent-cyan-500"/><span>Điều chỉnh thời gian <strong>kết thúc</strong></span></label>
                  <div class="flex items-center gap-2">
                    <span class="text-sm">Δ (giây):</span>
                    <input id="ba-end-delta" type="number" step="0.1" value="0" class="w-28 bg-gray-900 border border-gray-500 rounded px-2 py-1 text-sm"/>
                  </div>
                </div>
              </div>
            </div>
            <div class="flex justify-end gap-2 pt-2">
              <button class="cancel-btn bg-gray-600 hover:bg-gray-500 text-white px-3 py-2 rounded">Hủy</button>
              <button id="ba-apply" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded">Áp dụng</button>
            </div>
          </div>`;
        showModal(modalHtml, (m)=>{
          const startDeltaInp = m.querySelector('#ba-start-delta');
          const endDeltaInp = m.querySelector('#ba-end-delta');
          const startChk = m.querySelector('#ba-start');
          const endChk = m.querySelector('#ba-end');

          // auto tick when delta != 0
          startDeltaInp.addEventListener('input', ()=>{ startChk.checked = Math.abs(parseFloat(startDeltaInp.value||'0')) > 0; });
          endDeltaInp.addEventListener('input', ()=>{ endChk.checked = Math.abs(parseFloat(endDeltaInp.value||'0')) > 0; });

          m.querySelector('#ba-apply').onclick=()=>{
            const doDel = m.querySelector('#ba-del').checked;
            const doStart = startChk.checked;
            const doEnd = endChk.checked;
            const dStart = parseFloat(startDeltaInp.value||'0');
            const dEnd = parseFloat(endDeltaInp.value||'0');
            const idxs = Array.from(selectedRows).sort((a,b)=>b-a);
            if(doDel){
              for(const i of idxs){ subtitles.splice(i,1); if(isComparing) originalSubtitles.splice(i,1); }
            }
            if(doStart || doEnd){
              for(const i of Array.from(selectedRows).sort((a,b)=>a-b)){
                if(doStart){ subtitles[i].startTime = Math.max(0, subtitles[i].startTime + dStart); }
                if(doEnd){ subtitles[i].endTime = Math.max(0.01, subtitles[i].endTime + dEnd); }
              }
            }
            markDirty(); resortSubtitlesByTime(); displaySubtitles();
            toggleBatchMode(false);
            showNotification('Đã áp dụng thay đổi hàng loạt.','success');
            m.remove();
          };
        });
      }
    });
    batchSelectAll?.addEventListener('change', (e)=>{
      if(e.target.checked){ selectedRows = new Set(subtitles.map((_,i)=>i)); }
      else selectedRows.clear();
      displaySubtitles(); updateBatchBtnState();
    });

    /* ===== Find & Replace (bulk) ===== */
    function escapeRegExp(str){ return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    function buildFindRegex(txt, caseSensitive, wholeWord){
      const esc = escapeRegExp(txt);
      const flags = caseSensitive ? 'gu' : 'giu';
      if(!wholeWord){
        return new RegExp(esc, flags);
      } else {
        // Whole word by spaces (start or whitespace) + term + (whitespace or end)
        // Use capturing group to preserve leading space on replace
        return new RegExp(`(^|\\s)(${esc})(?=\\s|$)`, flags);
      }
    }
    function frCount(){
      const q = frFind.value||'';
      if(!q){ frResult.textContent='Nhập chuỗi cần tìm.'; return; }
      const re = buildFindRegex(q, frCase.checked, frWhole.checked);
      let cnt=0;
      for(const s of subtitles){
        if(frWhole.checked){
          // Count matches with leading space group
          const m = s.text.match(re);
          if(!m){ /* nothing */ }
          const it = s.text.matchAll(re);
          for(const _ of it) cnt++;
        }else{
          const it = s.text.matchAll(re);
          for(const _ of it) cnt++;
        }
      }
      frResult.textContent = `Tìm thấy ${cnt} kết quả.`;
    }
    function frReplaceAll(){
      const q = frFind.value||'';
      const rep = frReplace.value||'';
      if(!q){ frResult.textContent='Nhập chuỗi cần tìm.'; return; }
      const re = buildFindRegex(q, frCase.checked, frWhole.checked);
      let changes=0;
      subtitles = subtitles.map(s=>{
        let text=s.text;
        if(frWhole.checked){
          text = text.replace(re, (_m, g1, _g2)=> `${g1}${rep}`);
        }else{
          text = text.replace(re, rep);
        }
        if(text!==s.text){ changes++; }
        return {...s, text};
      });
      displaySubtitles();
      if(changes>0) markDirty();
      frResult.textContent = `Đã thay thế trong ${changes} dòng.`;
    }
    frCountBtn.addEventListener('click', frCount);
    frReplaceAllBtn.addEventListener('click', frReplaceAll);

    /* ===== Init ===== */
    function init(){
      expandTools(false);
      setSubsHeaderHeightVar();
    }
    init();
    
    // Move select-all under buttons row once
    try{ const wrap=document.getElementById('batch-selectall-wrap'); const btnRow=batchBtn?.parentElement; if(wrap && btnRow && btnRow.parentElement){ btnRow.parentElement.insertBefore(wrap, btnRow.nextSibling); } }catch{}

    // --- Added features: save VTT ---
    function saveVTTFile(){
      try{
        if(!subtitles || !subtitles.length) return showNotification('Không có phụ đề để lưu.','warning');
        const toVttTime=(t)=>{ const h=String(Math.floor(t/3600)).padStart(2,'0'); const m=String(Math.floor((t%3600)/60)).padStart(2,'0'); const s=String(Math.floor(t%60)).padStart(2,'0'); const ms=String(Math.round((t-Math.floor(t))*1000)).padStart(3,'0'); return `${h}:${m}:${s}.${ms}`; };
        const vtt = 'WEBVTT\n\n' + subtitles.map(s=>`${toVttTime(s.startTime)} --> ${toVttTime(s.endTime)}\n${s.text}`).join('\n\n');
        const blob=new Blob([vtt],{type:'text/vtt;charset=utf-8'});
        const videoBase=videoFile?baseNameNoExt(videoFile.name):'subtitles';
        const code=currentSubLangCode||'unk';
        const filename=`${videoBase}_${code}.vtt`;
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href);
        clearDirty();
        showNotification(`Đã lưu: ${filename}`,'success');
      }catch(e){ showNotification('Không thể lưu VTT: '+e.message,'error'); }
    }
    document.getElementById('save-vtt')?.addEventListener('click', saveVTTFile);
    // --- Undo/Redo basic ---
    if(typeof undoStack==='undefined'){ var undoStack=[]; var redoStack=[]; }
    function pushUndo(){ try{ undoStack.push(JSON.parse(JSON.stringify(subtitles))); if(undoStack.length>50) undoStack.shift(); redoStack.length=0; }catch{} }
    function undo(){ if(!undoStack.length) return; redoStack.push(JSON.parse(JSON.stringify(subtitles))); subtitles = undoStack.pop(); displaySubtitles(); markDirty(false); }
    function redo(){ if(!redoStack.length) return; undoStack.push(JSON.parse(JSON.stringify(subtitles))); subtitles = redoStack.pop(); displaySubtitles(); markDirty(false); }
    window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){ e.preventDefault(); if(e.shiftKey) redo(); else undo(); } else if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='y'){ e.preventDefault(); redo(); } });
    // caret tracking + live cps/cpl
    let lastCaretIndex=-1, lastCaretChar=0;

    // --- Keyboard shortcuts for playback/navigation ---
    function isTypingTarget(el){ return el && (el.isContentEditable || ['INPUT','TEXTAREA','SELECT'].includes(el.tagName)); }
    window.addEventListener('keydown', (e)=>{
      if(isTypingTarget(e.target)) return;
      if(e.code==='Space'){ e.preventDefault(); togglePlayPause(); }
      else if(e.key==='j' || e.key==='J'){ videoPlayer.playbackRate=Math.max(.25, Math.round((videoPlayer.playbackRate-.25)*4)/4); showNotification(`Tốc độ: x${videoPlayer.playbackRate}`,'warning',1200); }
      else if(e.key==='k' || e.key==='K'){ togglePlayPause(); }
      else if(e.key==='l' || e.key==='L'){ videoPlayer.playbackRate=Math.min(3, Math.round((videoPlayer.playbackRate+.25)*4)/4); showNotification(`Tốc độ: x${videoPlayer.playbackRate}`,'success',1200); }
      else if(e.key==='ArrowLeft'){ videoPlayer.currentTime=Math.max(0, (videoPlayer.currentTime-5)); }
      else if(e.key==='ArrowRight'){ videoPlayer.currentTime=Math.min(videoPlayer.duration||Infinity, (videoPlayer.currentTime+5)); }
      else if(e.key==='ArrowUp'){ const i=Math.max(0,(currentSubtitleIndex>0?currentSubtitleIndex-1:0)); scrollToSubtitleIndex(i); videoPlayer.currentTime=subtitles[i]?.startTime||videoPlayer.currentTime; }
      else if(e.key==='ArrowDown'){ const i=Math.min(subtitles.length-1,(currentSubtitleIndex>=0?currentSubtitleIndex+1:0)); scrollToSubtitleIndex(i); videoPlayer.currentTime=subtitles[i]?.startTime||videoPlayer.currentTime; }
    });

    // --- Autosave + beforeunload ---
    const AUTOSAVE_KEY='autosave_subtitles_v1';
    function scheduleAutosave(){ try{ localStorage.setItem(AUTOSAVE_KEY, JSON.stringify({ subtitles, lang: currentSubLangCode||'unk', ts: Date.now() })); }catch{} }
    // markDirty đã được cập nhật để autosave trong định nghĩa gốc
    window.addEventListener('beforeunload', (e)=>{ if(isDirty){ e.preventDefault(); e.returnValue=''; } });
    try{ const raw=localStorage.getItem(AUTOSAVE_KEY); if(raw){ const obj=JSON.parse(raw); if(obj && Array.isArray(obj.subtitles) && !subtitles.length){ showConfirmModal('Khôi phục phiên làm việc trước?', ()=>{ subtitles=obj.subtitles; originalSubtitles=JSON.parse(JSON.stringify(subtitles)); areSubsLoaded=true; displaySubtitles(); updateSubLangDisplay('Khôi phục', obj.lang||'unk'); clearDirty(); }, ()=>{}); } } }catch{}

    // --- Context menu actions ---
    const contextMenu = document.getElementById('context-menu');
    const ctxDupBtn = contextMenu?.querySelector('#ctx-dup');
    const ctxSplitBtn = contextMenu?.querySelector('#ctx-split');
    const ctxMergeBtn = contextMenu?.querySelector('#ctx-merge-next');
    const ctxDeleteBtn = contextMenu?.querySelector('#ctx-delete');
    const ctxFixBtn = contextMenu?.querySelector('#ctx-fix-overlaps');
    let ctxIndex=-1;
    function showContextMenu(x,y){ contextMenu.style.left=x+'px'; contextMenu.style.top=y+'px'; contextMenu.style.display='block'; }
    function hideContextMenu(){ contextMenu.style.display='none'; }
    subtitleList?.addEventListener('contextmenu', (e)=>{ const item=e.target.closest('.subtitle-item'); if(!item) return; e.preventDefault(); const id=item.id||''; const m=id.match(/sub-(\d+)/); if(!m) return; ctxIndex=+m[1]; showContextMenu(e.clientX, e.clientY); });
    window.addEventListener('click', hideContextMenu);
    ctxDupBtn?.addEventListener('click', ()=>{ if(ctxIndex<0) return; try{ pushUndo(); }catch{} const cur=subtitles[ctxIndex]; const copy={...cur}; subtitles.splice(ctxIndex+1,0,copy); markDirty(); displaySubtitles(); hideContextMenu(); scrollToSubtitleIndex(ctxIndex+1); const row=document.getElementById(`sub-${ctxIndex+1}`); row?.classList.add('flash-highlight'); setTimeout(()=>row?.classList.remove('flash-highlight'),1200); showNotification('Đã nhân bản dòng.','success'); });
    ctxSplitBtn?.addEventListener('click', ()=>{
      if(ctxIndex<0) return; const cur=subtitles[ctxIndex]; const full=cur.text||'';
      let caret = (lastCaretIndex===ctxIndex) ? lastCaretChar : Math.floor(full.length/2);
      caret = Math.max(0, Math.min(full.length, caret));
      const ratio = full.length>0 ? (caret/full.length) : 0.5;
      const mid = cur.startTime + (cur.endTime - cur.startTime) * ratio;
      try{ pushUndo(); }catch{}
      const t1={ startTime:cur.startTime, endTime:mid, text: full.slice(0, caret) };
      const t2={ startTime:mid, endTime:cur.endTime, text: full.slice(caret) };
      subtitles.splice(ctxIndex,1,t1,t2); markDirty(); displaySubtitles(); hideContextMenu(); scrollToSubtitleIndex(ctxIndex); const row=document.getElementById(`sub-${ctxIndex}`); row?.classList.add('flash-highlight'); setTimeout(()=>row?.classList.remove('flash-highlight'),1200); showNotification('Đã chia đoạn tại trỏ chuột.','success');
    });
    ctxMergeBtn?.addEventListener('click', ()=>{ if(ctxIndex<0 || ctxIndex>=subtitles.length-1) return; try{ pushUndo(); }catch{} const a=subtitles[ctxIndex], b=subtitles[ctxIndex+1]; const merged={ startTime:a.startTime, endTime:Math.max(a.endTime,b.endTime), text:(a.text+(a.text.endsWith('\n')?'':'\n')+b.text) }; subtitles.splice(ctxIndex,2,merged); markDirty(); displaySubtitles(); hideContextMenu(); scrollToSubtitleIndex(ctxIndex); const row=document.getElementById(`sub-${ctxIndex}`); row?.classList.add('flash-highlight'); setTimeout(()=>row?.classList.remove('flash-highlight'),1200); showNotification('Đã gộp với dòng sau.','success'); });
    ctxDeleteBtn?.addEventListener('click', ()=>{ if(ctxIndex<0) return; const i=ctxIndex; showConfirmModal(`Xóa dòng phụ đề ${i+1}?`, ()=>{ try{ pushUndo(); }catch{} subtitles.splice(i,1); markDirty(); displaySubtitles(); hideContextMenu(); showNotification('Đã xóa dòng.','success'); }, ()=>hideContextMenu()); });
    ctxFixBtn?.addEventListener('click', ()=>{ hideContextMenu(); try{ pushUndo(); }catch{} for(let i=0;i<subtitles.length-1;i++){ const cur=subtitles[i], nxt=subtitles[i+1]; if(cur.endTime > nxt.startTime - 0.08){ cur.endTime = Math.max(cur.startTime, nxt.startTime - 0.08); } } markDirty(); displaySubtitles(); });

    // --- Loading overlay ---
    setTimeout(()=> document.getElementById('initial-loading')?.classList.add('hidden'), 1000);

  </script>
  <!-- Context menu template -->
  <div id="context-menu" class="shadow-lg">
    <button id="ctx-dup" class="flex items-center gap-2">
      <svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
      <span>Nhân bản dòng</span>
    </button>
    <button id="ctx-split" class="flex items-center gap-2">
      <svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 3h5v5"/><path d="M8 3H3v5"/><path d="M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3"/><path d="m15 9 6-6"/></svg>
      <span>Chia đoạn (tại điểm chọn)</span>
    </button>
    <button id="ctx-merge-next" class="flex items-center gap-2">
      <svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 18H5a3 3 0 0 1-3-3v-1"/><path d="M14 2a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2"/><path d="M20 2a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2"/><path d="m7 21 3-3-3-3"/><rect x="14" y="14" width="8" height="8" rx="2"/><rect x="2" y="2" width="8" height="8" rx="2"/></svg>
      <span>Gộp với dòng sau</span>
    </button>
    <button id="ctx-delete" class="text-red-400 flex items-center gap-2">
      <svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 11v6"/><path d="M14 11v6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
      <span>Xóa</span>
    </button>
    <div class="border-t border-gray-700"></div>
    <button id="ctx-fix-overlaps" class="flex items-center gap-2">
      <svg aria-hidden="true" class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/><path d="M11 3H9"/></svg>
      <span>Sửa chồng lấn</span>
    </button>
  </div>
</body>
</html>
